# Simulating hyperspectral fiber photometry signals

A recap of the basic model for fluorescence signals from protein indicators

## Phenomenological model for observed signal
$$
\def\lexc{\lambda^{\dagger}_{j}}
\gdef\colA#1{\textcolor{6488EA}{#1}}
\gdef\colB#1{\textcolor{AA2704}{#1}}
$$

|Type  | Symbol              | Code     | Description     |
|:-----|:-------------------:|:---------|:----------------|
|      | $O(t,\lambda,j)$    | O        | observed signal from the $j$-th laser at time $t$ at spectral wavelength $\lambda$  | 
|Const | $s(i,\lambda)$      | S        | emission spectrum of sensor associated with $i$-th neuromodulator                   | 
|Const | $e(\lambda,j)$      | E        | time-invariant spectral signature of $j$-th excitation laser                        | 
|Const | $\mu_\textrm{oxy}(\lambda)$   | Mu_ox  | Spectrum of oxygenated hemolobin                                            |
|Const | $\mu_\textrm{deoxy}(\lambda)$ | Mu_dox | Spectrum of deoxygenated hemolobin                                          |
|Param | $w(i,j)$              | W        | emission efficiency of $i$-th neuromodulator excited by $j$-th laser              | 
|Param | $a(i,t)$              | A        | sensor signal from time varying amount for the $i$-th neuromodulator              | 
|Param | $n(t,j)$              | N        | noise from $j$-th laser                                                           | 
|Param | $b(\lambda,j)$        | B        | patch cord + laser fluorescence spectrum $j$-th laser                             | 
|Param | $m(t)$                | M        | motion correction (potentially depends on $i$)                                    | 
|Param | $h_\textrm{oxy}(t)$   | H_ox     | Hemodynamics (oxygenated component)                                               |
|Param | $h_\textrm{deoxy}(t)$ | H_dox    | Hemodynamics (deoxygenated component)                                             |


#### Assumptions / caveats

 - We may ignore spatial variation (e.g. related to illumination/ detection)
 - We may assume bound fraction is small ($f \ll 1$)
 - We may assume that $\frac{\Delta F}{F} \ll (\frac{\Delta F}{F})_\textrm{max}$

#### Indicator bleaching

The total number of indicator molecules that can fluoresce reduces over time and this is referred to as bleaching. Here we model bleaching as a sum of exponentials, one with a fast time constant and one with a slow time constant.
$$C(t) = C_\textrm{slow} e^{-\frac{t}{\tau_\textrm{slow}}} + C_\textrm{fast} e^{-\frac{t}{\tau_\textrm{fast}}}$$

#### Indicator signal

The fluorescing indicator molecules can exist in one of two states, bound to ligand or free. Let the fraction of the bound indicator be $f_{\textrm{b}}(t)$. Assuming emission spectra $S_\textrm{b}(\lambda)$ and $S_\textrm{f}(\lambda)$ for the different indicator states, power of the $j$<sup>th</sup> laser $P(j,t)$, and efficiency of the laser to excite populations $w_\textrm{b}(j)$ and $w_\textrm{f}(j)$, the fluorescence readout $F(t,\lambda,j)$ is modeled as:

$$
\begin{align*}
F(t,\lambda,j) = & \colA{f_{\textrm{b}}(t) S_\textrm{b}(\lambda)w_\textrm{b}(j) C(t) P(j,t)} + \\
                 & \colB{(1 - f_{\textrm{b}}(t)) S_\textrm{f}(\lambda)w_\textrm{f}(j) C(t) P(j,t)} 
\end{align*}
$$ {#eq-single-indicator}

@eq-single-indicator is analogous to the setup in and in @helmchen2011calibration. In the following, we'll refer to $f_{\textrm{b}}$ as simply $f$. Assuming a positive indicator (where the bound state is brighter than free state), define $F_{\max}$ and $F_{\min}$ as the signal when $f=0$ and $f=1$ respectively. We'll pack terms other than $f$ in @eq-single-indicator into $\eta_\textrm{b}$ and $\eta_\textrm{f}$ for the bound and free components and also drop the arguments for $t$, $\lambda$, $j$ for now. Then:

$$
\begin{align*}
F &= \eta_{\textrm{b}}f + \eta_{\textrm{f}}(1-f)\\
  &= F_{\min} + (\eta_{\textrm{b}} − \eta_{\textrm{f}})f \\
  &= F_{\max} − (\eta_{\textrm{b}} − \eta_{\textrm{f}})(1-f) \\
\implies \frac{f}{1-f} &= \frac{F - F_{\min}}{F_{\max} - F} \\
\end{align*}
$$ {#eq-bound-fraction}

Defining $R := {F_{\max}}/{F_{\min}}$, we can rewrite @eq-bound-fraction as:
$$
\frac{f}{1-f} = \frac{F / F_{\max} − 1 / R}{1 − F / F_{\max}}
$$ {#eq-bound-fraction-rel}

@eq-bound-fraction-rel is only contains ratios of fluorosence; these terms are invariant to indicator concentration (assuming it is non-zero), and laser power as in @eq-single-indicator 

#### Relating ligand concentration to fluorescence

This section is based on discussions in @helmchen2011calibration and @grynkiewicz1985new to relate observed signal to ligand ($\textrm{Ca}^{2+}$ in these studies) concentration in imaging experiments.

For indicator protein $P$ and the ligand $L$, assumiing 1:1 complexation (i.e. 1 molecule of $P$ binds to 1 molecule of $L$):

$$
L + P \xrightleftharpoons[k_{d}]{k_{a}} LP
$$

At equillibrium:
$$
k_d[LP] = k_a[L][P]
$$

The dissociation constant $K$ is defined as $\frac{k_d}{k_a}$:

$$
K = \frac{[L][P]}{[LP]} \qquad [P] = \frac{K[LP]}{[L]}
$$

The fraction of bound indicator $f$:
$$
f = \frac{[LP]}{[P] + [LP]} 
 = \frac{[L]}{K + [L]}
$$

Then $[L]$ can be expressed as a function of $f$, and using @eq-bound-fraction, we relate the ligand concentration to the observed fluoresence signal.
$$
[L] = K\frac{f}{1-f} = K\frac{F - F_{\min}}{F_{\max} - F} = K\frac{F / F_{\max} − 1 / R}{1 − F / F_{\max}}
$$

As a further simplification, for $f \ll 1$, $[L] \approx Kf$ (Taylor expansion of $\frac{f}{1-f}$ around $f=0$). 

#### Relating ligand concentration to $\Delta F / F$

Measuring $F_{\min}$ can be a problem, because of the presence of a baseline ligand concentration $[L]_\textrm{rest}$, which is associated with a baseline fluorescence signal $F_\textrm{rest}$. Using the equation derived in the section above:

\begin{align*}
[L]_\textrm{rest} &= K\frac{F_\textrm{rest} - F_{\min}}{F_{\max} - F_\textrm{rest}}  \\
 F_{\min} &= F_\textrm{rest} - \frac{[L]_\textrm{rest}({F_{\max} - F_\textrm{rest}})}{K}   \\
\end{align*}

Replace $F_{\min}$ in the expression for $[L]$:

\begin{align*}
[L] &= K\frac{F - F_{\min}}{F_{\max} - F} \\
    &= K\frac{F - (F_\textrm{rest} - \frac{[L]_\textrm{rest}({F_{\max} - F_\textrm{rest}})}{K})}{F_{\max} - F} \\
    &= \frac{K(F - F_\textrm{rest}) + [L]_\textrm{rest}({F_{\max} - F_\textrm{rest}})}{F_{\max} - F} \\
    &= \frac{[L]_\textrm{rest} + K\frac{F - F_\textrm{rest}}{F_{\max} - F_\textrm{rest}}}{ 1-\frac{F - F_\textrm{rest}}{F_{\max} - F_\textrm{rest}}} \\
\end{align*}

Define $\frac{\Delta F}{F} := \frac{F-F_\textrm{rest}}{F_\textrm{rest}}$ and $(\frac{\Delta F}{F})_{\max} := \frac{F_{\max}-F_\textrm{rest}}{F_\textrm{rest}}$. Then we can rewrite $[L]$ in terms of these quantities:

\begin{align*}
[L] &= \frac{[L]_\textrm{rest} + K (\frac{\Delta F}{F}) / (\frac{\Delta F}{F})_{\max}}{ 1-(\frac{\Delta F}{F}) / (\frac{\Delta F}{F})_{\max}} \\
\end{align*}

This equation is of the form $f(x) = \frac{a + bx}{1-x}$. For small $x$, the Taylor series expansion around 0 is $a+(a+b)x+\mathcal{O}(x)^{2}$. 

Therefore for small $(\frac{\Delta F}{F}) / (\frac{\Delta F}{F})_{\max}$ 

\begin{align*}
[L] & \approx [L]_\textrm{rest} + ([L]_\textrm{rest} + ({K} / (\frac{\Delta F}{F})_{\max})\frac{\Delta F}{F} \\
\Delta [L] & := [L] - [L]_\textrm{rest} \\
         & \approx ([L]_\textrm{rest} + {K} / (\frac{\Delta F}{F})_{\max})\frac{\Delta F}{F} \\
         & \approx \textrm{constant} \times \frac{\Delta F}{F}
\end{align*}

The constant has terms $[L]_\textrm{rest}$ (depends on cell/region being imaged), $K$ (property of the indicator) and $(\frac{\Delta F}{F})_{\max}$ (depends on the indicator and optical setup).

---

In conventional Calcium imaging experiments, there are heuristic computational procedures to estimate the second term as $\colB{F_0(t)}$, and calculate $\frac{\Delta F}{F}(t)$ as:

$$
\frac{\Delta F}{F}(t) = \frac{F(t,\lambda,j) - F_0(t)}{F_0(t)} = \frac{\colA{f(t) S_\textrm{bound}(\lambda)w_\textrm{bound}(j)}}{\colB{S_\textrm{free}(\lambda)w_\textrm{free}(j)}}
$$ {#eq-dff}


For experiments involving one indicator excited by a single laser and measured in a particular region of the emission spectrum, the estimated $\frac{\Delta F}{F} \propto f(t)$ according to this model. This is a common strategy adopted for analysis in fiber photometry experiments.

With multiple indicators, the fluorescence signal would consist of indicator-specific terms as shown for one indicator in @eq-dff. If the terms $S_\textrm{bound}(\lambda)w_\textrm{bound}(j)$ and $S_\textrm{free}(\lambda)w_\textrm{free}(j)$ don't suppress terms from other indicators, the $\frac{\Delta F}{F}$ signal can no longer be interpreted as a measure of $f(t)$ for each indicator.

The workaround is to then look for $\lambda$ where this is going to be largely the case. We'll treat this approach as a baseline strategy. 



The fraction of molecules in the bright state is $f(t)$, and the fraction in the dark state is $1 - f(t)$. The emission spectrum of the bright state is $s_\textrm{bound}(\lambda)$ and the emission spectrum of the dark state is $s_\textrm{free}(\lambda)$. The total emission spectrum of the indicator is a weighted sum of the two spectra, with weights $f(t)$ and $1 - f(t)$. 

$$
\begin{align}
O(t,\lambda,j) &= [ \left( \sum_{i \in \{\textrm{I},\textrm{AF}\}}{a(i,t) s(i,\lambda) w(i,j)} \right) H(t, \lambda) m(t) + b(\lambda,j) ] n(t,j) \\
H(t, \lambda) &= e^{-(\mu_{\textrm{oxy}(\lambda)}h_{\textrm{oxy}}(t) + \mu_{\textrm{deoxy}(\lambda)}h_{\textrm{deoxy}}(t))}
\end{align}
$${#eq-observation}

- $a(i,t)$ for  $i \in \textrm{I}$ has fast and slow components
- $a(t) = c\{f(t)s_\textrm{bound}(\lambda) + (1-f(t))s_\textrm{free}(\lambda)\}$ : an indicator with concentration $c$ exists in two states (e.g. bright, dark or bound, free) that have their own emission spectra.
- Isosbestic point is the particular $\lambda$ where the two populations cannot be distinguished. This does not always exist for all indicators, but when it does exist it might be possible to use it for corrections related to Hemodynamics, see @zhang2022spectral
- $h_{\textrm{oxy}}(t), h_{\textrm{deoxy}}(t)$ : Blood concentration of hemoglobin in oxygenated or deoxygenated states over time
- $a(i,t)$ is multiplied by a decay term $d(i,t)$ associated with bleaching. $d(i,t) = d_\textrm{fast}(i)e^{-\frac{t}{\tau_\textrm{fast}}} + d_\textrm{slow}(i)e^{-\frac{t}{\tau_\textrm{slow}}} + d_\textrm{constant}(i)$


## Model for hemodynamics

Absorption by hemoglobin corrupts the signal. The Beer-Lambert law is used to model this effect in the generative model above.

 - $\varepsilon$: extinction coefficient (in $\textrm{cm}^{-1}\textrm{mole}^{-1}{L}$), see @hemoglobinspectra. This is a function of $\lambda$ 
 - $h$: concentration (100 to 200 $gL^{-1}$ for Hemoglobin in brain, is a function of time, and linked to brain region-specific neuron activity
 - $l$: effective cuvette length in the Beer-Lambert law. We set this to 1 $\textrm{cm}$, and assume no dependence on $\lambda$ here. 
 - $M_{\textrm{Hg}}$: molar mass of Hemoglobin = 64,500 $g\textrm{mole}^{-1}$
 - $A$: absorbance, calculated as per Beer-Lambert's law $A = \frac{\varepsilon \times h \times {l}}{M_{\textrm{Hg}}}$
 - Let $f(t)$ be fraction of hemoglobin in the oxygenated state. Define $h_{\textrm{oxy}}$, $h_{\textrm{deoxy}}$, $\mu_\textrm{oxy}$ and $\mu_\textrm{deoxy}$ as:


$$
\begin{align*}
h_\textrm{oxy}(t) &= f(t)h_{\textrm{total}}(t) \\
h_\textrm{deoxy}(t) &= (1 - f(t))h_{\textrm{total}}(t) \\
\mu_\textrm{oxy}(\lambda) &= \tfrac{\varepsilon_{\textrm{oxy}}(\lambda)}{M_{\textrm{Hg}}} \\
\mu_\textrm{deoxy}(\lambda) &= \tfrac{\varepsilon_{\textrm{deoxy}}(\lambda)}{M_{\textrm{Hg}}}
\end{align*}
$$

 - Replacing $A$ in the definition of absorbance: $\frac{I}{I_o} = e^{-A}$: 
$$
I(\lambda, t) = I_o(\lambda, t) e^{-(\mu_{\textrm{oxy}(\lambda)}h_{\textrm{oxy}}(t) + \mu_{\textrm{deoxy}(\lambda)}h_{\textrm{deoxy}}(t))}
$$

## Autofluorescence

Autofluorescence has a spectrum @autofluorescencepectra, and it varies with time due to metabolic activity. NADH and FAD are molecules that fluoresce in the 400 nm - 700 nm range, see measurements in aqueous solutions in @islam2013ph.