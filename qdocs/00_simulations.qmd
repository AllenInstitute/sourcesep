# Simulating hyperspectral fiber photometry signals

## Phenomenological model for observed signal
$$
\def\lexc{\lambda^{\dagger}_{j}}
$$

|Type  | Symbol              | Code     | Description     |
|:-----|:-------------------:|:---------|:----------------|
|      | $O(t,\lambda,j)$    | O        | observed signal from the $j$-th laser at time $t$ at spectral wavelength $\lambda$  | 
|Const | $s(i,\lambda)$      | S        | emission spectrum of sensor associated with $i$-th neuromodulator                   | 
|Const | $e(\lambda,j)$      | E        | time-invariant spectral signature of $j$-th excitation laser                        | 
|Const | $\mu_\textrm{oxy}(\lambda)$   | Mu_ox  | Spectrum of oxygenated hemolobin                                            |
|Const | $\mu_\textrm{deoxy}(\lambda)$ | Mu_dox | Spectrum of deoxygenated hemolobin                                          |
|Param | $w(i,j)$              | W        | emission efficiency of $i$-th neuromodulator excited by $j$-th laser              | 
|Param | $a(i,t)$              | A        | sensor signal from time varying amount for the $i$-th neuromodulator              | 
|Param | $n(t,j)$              | N        | noise from $j$-th laser                                                           | 
|Param | $b(\lambda,j)$        | B        | patch cord + laser fluorescence spectrum $j$-th laser                             | 
|Param | $m(t)$                | M        | motion correction (potentially depends on $i$)                                    | 
|Param | $h_\textrm{oxy}(t)$   | H_ox     | Hemodynamics (oxygenated component)                                               |
|Param | $h_\textrm{deoxy}(t)$ | H_dox    | Hemodynamics (deoxygenated component)                                             |


$$
\begin{align}
O(t,\lambda,j) &= [ \left( \sum_{i \in \{\textrm{I},\textrm{AF}\}}{a(i,t) s(i,\lambda) w(i,j)} \right) H(t, \lambda) m(t) + b_(\lambda,j) ] n(t,j) \\
H(t, \lambda) &= e^{-(\mu_{\textrm{oxy}(\lambda)}h_{\textrm{oxy}}(t) + \mu_{\textrm{deoxy}(\lambda)}h_{\textrm{deoxy}}(t))}
\end{align}
$${#eq-observation}

- $a(i,t)$ for  $i \in \textrm{I}$ has fast and slow components
- $a(t) = c\{f(t)s_\textrm{bound}(\lambda) + (1-f(t))s_\textrm{free}(\lambda)\}$ : an indicator with concentration $c$ exists in two states (e.g. bright, dark or bound, free) that have their own emission spectra.
- Isosbestic point is the particular $\lambda$ where the two populations cannot be distinguished. This does not always exist for all indicators, but when it does exist it might be possible to use it for corrections related to Hemodynamics, see @zhang2022spectral
- $h_{\textrm{oxy}}(t), h_{\textrm{deoxy}}(t)$ : Blood concentration of hemoglobin in oxygenated or deoxygenated states over time


## Model for hemodynamics

Absorption by hemoglobin corrupts the signal. The Beer-Lambert law is used to model this effect in the generative model above.

 - $\varepsilon$: extinction coefficient (in $\textrm{cm}^{-1}\textrm{mole}^{-1}{L}$), see @hemoglobinspectra. This is a function of $\lambda$ 
 - $h$: concentration (100 to 200 $gL^{-1}$ for Hemoglobin in brain, is a function of time, and linked to brain region-specific neuron activity
 - $l$: effective cuvette length in the Beer-Lambert law. We set this to 1 $\textrm{cm}$, and assume no dependence on $\lambda$ here. 
 - $M_{\textrm{Hg}}$: molar mass of Hemoglobin = 64,500 $g\textrm{mole}^{-1}$
 - $A$: absorbance, calculated as per Beer-Lambert's law $A = \frac{\varepsilon \times h \times {l}}{M_{\textrm{Hg}}}$
 - Let $f(t)$ be fraction of hemoglobin in the oxygenated state. Define $h_{\textrm{oxy}}$, $h_{\textrm{deoxy}}$, $\mu_\textrm{oxy}$ and $\mu_\textrm{deoxy}$ as:


$$
\begin{align*}
h_\textrm{oxy}(t) &= f(t)h_{\textrm{total}}(t) \\
h_\textrm{deoxy}(t) &= (1 - f(t))h_{\textrm{total}}(t) \\
\mu_\textrm{oxy}(\lambda) &= \tfrac{\varepsilon_{\textrm{oxy}}(\lambda)}{M_{\textrm{Hg}}} \\
\mu_\textrm{deoxy}(\lambda) &= \tfrac{\varepsilon_{\textrm{deoxy}}(\lambda)}{M_{\textrm{Hg}}}
\end{align*}
$$

 - Replacing $A$ in the definition of absorbance: $\frac{I}{I_o} = e^{-A}$: 
$$
I(\lambda, t) = I_o(\lambda, t) e^{-(\mu_{\textrm{oxy}(\lambda)}h_{\textrm{oxy}}(t) + \mu_{\textrm{deoxy}(\lambda)}h_{\textrm{deoxy}}(t))}
$$

## Autofluorescence

Autofluorescence has a spectrum @autofluorescencepectra, and it varies with time due to metabolic activity. NADH and FAD are molecules that fluoresce in the 400 nm - 700 nm range, see measurements in aqueous solutions in @islam2013ph.

