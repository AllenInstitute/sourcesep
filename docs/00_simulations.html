<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Source separation - 1&nbsp; Simulating hyperspectral fiber photometry signals</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./01_methods.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./00_simulations.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Simulating hyperspectral fiber photometry signals</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Source separation</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_simulations.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Simulating hyperspectral fiber photometry signals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#signal-from-indicators" id="toc-signal-from-indicators" class="nav-link active" data-scroll-target="#signal-from-indicators"><span class="header-section-number">1.1</span> Signal from indicators</a></li>
  <li><a href="#autofluorescence" id="toc-autofluorescence" class="nav-link" data-scroll-target="#autofluorescence"><span class="header-section-number">1.2</span> Autofluorescence</a></li>
  <li><a href="#isosbestic-control" id="toc-isosbestic-control" class="nav-link" data-scroll-target="#isosbestic-control"><span class="header-section-number">1.3</span> Isosbestic control</a></li>
  <li><a href="#sec-hemodynamics" id="toc-sec-hemodynamics" class="nav-link" data-scroll-target="#sec-hemodynamics"><span class="header-section-number">1.4</span> Hemodynamics</a></li>
  <li><a href="#blooming-and-notch-filters" id="toc-blooming-and-notch-filters" class="nav-link" data-scroll-target="#blooming-and-notch-filters"><span class="header-section-number">1.5</span> Blooming and notch filters</a></li>
  <li><a href="#previous-approach-to-modeling-the-signal" id="toc-previous-approach-to-modeling-the-signal" class="nav-link" data-scroll-target="#previous-approach-to-modeling-the-signal"><span class="header-section-number">1.6</span> Previous approach to modeling the signal</a></li>
  <li><a href="#experiment-proposals" id="toc-experiment-proposals" class="nav-link" data-scroll-target="#experiment-proposals"><span class="header-section-number">1.7</span> Experiment proposals</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Simulating hyperspectral fiber photometry signals</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>A recap of the basic model for fluorescence signals from protein indicators.</p>
<p>The challenges for <em>in vivo</em> fiber photometry data analysis are highlighted in <span class="citation" data-cites="simpson2023lights">Simpson et al. (<a href="references.html#ref-simpson2023lights" role="doc-biblioref">2023</a>)</span>:</p>
<blockquote class="blockquote">
<p>In theory, or in a test tube or flow cell, dose-response curves make the relationship between ligand concentration and fluorescence intensity appear straightforward. However, measuring ligand modulated fluorescence in vivo, where photometric signals are neither linear nor absolute measures, is more complicated. Signals are influenced by native factors, including local fluctuations in pH and hemodynamics, and technical factors including the expression level and localization of the sensors, excitation wavelengths, potential photobleaching, and the stability of the optical path, each of which will be discussed.</p>
</blockquote>
<p>We are interested in the case where there there are multiple lasers exciting the samples at different wavelengths (time-division illumination), and the full emission spectrum can be observed.</p>
<section id="signal-from-indicators" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="signal-from-indicators"><span class="header-section-number">1.1</span> Signal from indicators</h2>
<section id="assumptions-caveats" class="level4">
<h4 class="anchored" data-anchor-id="assumptions-caveats">Assumptions / caveats</h4>
<ul>
<li>We may ignore spatial variation (e.g.&nbsp;related to illumination/ detection)</li>
<li>We may assume bound fraction is small (<span class="math inline">f \ll 1</span>)</li>
<li>We may assume that <span class="math inline">\frac{\Delta F}{F} \ll (\frac{\Delta F}{F})_\textrm{max}</span></li>
</ul>
</section>
<section id="indicator-bleaching" class="level4">
<h4 class="anchored" data-anchor-id="indicator-bleaching">Indicator bleaching</h4>
<p>The total number of indicator molecules that can fluoresce reduces over time and this is referred to as bleaching. Here we model bleaching as a sum of exponentials, one with a fast time constant and one with a slow time constant. <span class="math display">C(t) = C_\textrm{slow} e^{-\frac{t}{\tau_\textrm{slow}}} + C_\textrm{fast} e^{-\frac{t}{\tau_\textrm{fast}}}</span></p>
</section>
<section id="indicator-signal" class="level4">
<h4 class="anchored" data-anchor-id="indicator-signal">Indicator signal</h4>
<p>The fluorescing indicator molecules can exist in one of two states, bound to ligand or free. Let the fraction of the bound indicator be <span class="math inline">f_{\textrm{b}}(t)</span>. Assuming emission spectra <span class="math inline">S_\textrm{b}(\lambda)</span> and <span class="math inline">S_\textrm{f}(\lambda)</span> for the different indicator states, power of the <span class="math inline">j</span><sup>th</sup> laser <span class="math inline">P(j,t)</span>, and efficiency of the laser to excite populations <span class="math inline">w_\textrm{b}(j)</span> and <span class="math inline">w_\textrm{f}(j)</span>, the fluorescence readout <span class="math inline">F(t,\lambda,j)</span> is modeled as:</p>
<p><span id="eq-single-indicator"><span class="math display">
\begin{align*}
F(t,\lambda,j) = &amp; \textcolor{40bf9a}{f_{\textrm{b}}(t) C(t) S_\textrm{b}(\lambda)w_\textrm{b}(j) P(j,t)} + \\
                 &amp; \textcolor{63a7ff}{(1 - f_{\textrm{b}}(t)) C(t) S_\textrm{f}(\lambda)w_\textrm{f}(j) P(j,t)}
\end{align*}
\tag{1.1}</span></span></p>
<!-- \begin{align*}
F(t,\lambda,j) = & [\colg{f_{\textrm{b}}(t) C(t) S_\textrm{b}(\lambda)w_\textrm{b}(j) P(j,t)} + \\
                 & \colb{(1 - f_{\textrm{b}}(t)) C(t) S_\textrm{f}(\lambda)w_\textrm{f}(j) P(j,t)} + \\
                 & \colr{a(t) S_\textrm{a}(\lambda)w_\textrm{f}(j) P(j,t)}] H(t,\lambda)
\end{align*} -->
<p><a href="#eq-single-indicator" class="quarto-xref">Equation&nbsp;<span>1.1</span></a> is analogous to the setup in and in <span class="citation" data-cites="helmchen2011calibration">Helmchen (<a href="references.html#ref-helmchen2011calibration" role="doc-biblioref">2011</a>)</span>. In the following we refer to <span class="math inline">f_{\textrm{b}}</span> as just <span class="math inline">f</span>. Assuming a positive indicator (where the bound state is brighter than free state), define <span class="math inline">F_{\max}</span> and <span class="math inline">F_{\min}</span> as the signal when <span class="math inline">f=0</span> and <span class="math inline">f=1</span> respectively. We’ll pack terms other than <span class="math inline">f</span> in <a href="#eq-single-indicator" class="quarto-xref">Equation&nbsp;<span>1.1</span></a> into <span class="math inline">\eta_\textrm{b}</span> and <span class="math inline">\eta_\textrm{f}</span> for the bound and free components, and drop the arguments <span class="math inline">t</span>, <span class="math inline">\lambda</span>, <span class="math inline">j</span> for now. Then:</p>
<p><span id="eq-bound-fraction"><span class="math display">
\begin{align*}
F &amp;= \eta_{\textrm{b}}f + \eta_{\textrm{f}}(1-f)\\
  &amp;= F_{\min} + (\eta_{\textrm{b}} - \eta_{\textrm{f}})f \\
  &amp;= F_{\max} − (\eta_{\textrm{b}} − \eta_{\textrm{f}})(1-f) \\
\implies \frac{f}{1-f} &amp;= \frac{F - F_{\min}}{F_{\max} - F} \\
\end{align*}
\tag{1.2}</span></span></p>
<p>Defining <span class="math inline">R := {F_{\max}}/{F_{\min}}</span>, we can rewrite <a href="#eq-bound-fraction" class="quarto-xref">Equation&nbsp;<span>1.2</span></a> as: <span id="eq-bound-fraction-rel"><span class="math display">
\frac{f}{1-f} = \frac{F / F_{\max} − 1 / R}{1 − F / F_{\max}}
\tag{1.3}</span></span></p>
<p><a href="#eq-bound-fraction-rel" class="quarto-xref">Equation&nbsp;<span>1.3</span></a> only contains ratios of fluorosence; these terms are invariant to indicator concentration and laser power as in <a href="#eq-single-indicator" class="quarto-xref">Equation&nbsp;<span>1.1</span></a>.</p>
</section>
<section id="relating-ligand-concentration-to-fluorescence" class="level4">
<h4 class="anchored" data-anchor-id="relating-ligand-concentration-to-fluorescence">Relating ligand concentration to fluorescence</h4>
<p>This section is based on discussions in <span class="citation" data-cites="helmchen2011calibration">Helmchen (<a href="references.html#ref-helmchen2011calibration" role="doc-biblioref">2011</a>)</span> and <span class="citation" data-cites="grynkiewicz1985new">Grynkiewicz, Poenie, and Tsien (<a href="references.html#ref-grynkiewicz1985new" role="doc-biblioref">1985</a>)</span> to relate observed signal to ligand (<span class="math inline">\textrm{Ca}^{2+}</span> in these studies) concentration in imaging experiments.</p>
<p>For indicator protein <span class="math inline">P</span> and the ligand <span class="math inline">L</span>, assuming 1:1 complexation (i.e.&nbsp;1 molecule of <span class="math inline">P</span> binds to 1 molecule of <span class="math inline">L</span>):</p>
<p><span class="math display">
L + P \xrightleftharpoons[k_{d}]{k_{a}} LP
</span></p>
<p>At equilibrium: <span class="math display">
k_d[LP] = k_a[L][P]
</span></p>
<p>The dissociation constant <span class="math inline">K</span> is defined as <span class="math inline">\frac{k_d}{k_a}</span>:</p>
<p><span class="math display">
K = \frac{[L][P]}{[LP]} \qquad [P] = \frac{K[LP]}{[L]}
</span></p>
<p>The fraction of bound indicator <span class="math inline">f</span>: <span class="math display">
f = \frac{[LP]}{[P] + [LP]}
= \frac{[L]}{K + [L]}
</span></p>
<p>Then <span class="math inline">[L]</span> can be expressed as a function of <span class="math inline">f</span>, and using <a href="#eq-bound-fraction" class="quarto-xref">Equation&nbsp;<span>1.2</span></a>, we relate the ligand concentration to the observed fluoresence signal. <span id="eq-ligand-F"><span class="math display">
[L] = K\frac{f}{1-f} = K\frac{F - F_{\min}}{F_{\max} - F} = K\frac{F / F_{\max} − 1 / R}{1 − F / F_{\max}}
\tag{1.4}</span></span></p>
<p>As a further simplification, for <span class="math inline">f \ll 1</span> (Taylor expansion of <span class="math inline">\frac{f}{1-f}</span> around <span class="math inline">f=0</span>)</p>
<p><span id="eq-ligand-F-approx"><span class="math display">
[L] \approx Kf
\tag{1.5}</span></span></p>
</section>
<section id="relating-ligand-concentration-to-delta-f-f" class="level4">
<h4 class="anchored" data-anchor-id="relating-ligand-concentration-to-delta-f-f">Relating ligand concentration to <span class="math inline">\Delta F / F</span></h4>
<p>Measuring <span class="math inline">F_{\min}</span> can be a problem, because of the presence of a baseline ligand concentration <span class="math inline">[L]_\textrm{rest}</span>, which is associated with a baseline fluorescence signal <span class="math inline">F_\textrm{rest}</span>. Using the equation derived in the section above:</p>
<p><span class="math display">
\begin{align*}
[L]_\textrm{rest} &amp;= K\frac{F_\textrm{rest} - F_{\min}}{F_{\max} - F_\textrm{rest}}  \\
F_{\min} &amp;= F_\textrm{rest} - \frac{[L]_\textrm{rest}({F_{\max} - F_\textrm{rest}})}{K}   \\
\end{align*}
</span></p>
<p>Replace <span class="math inline">F_{\min}</span> in the expression for <span class="math inline">[L]</span>:</p>
<p><span class="math display">
\begin{align*}
[L] &amp;= K\frac{F - F_{\min}}{F_{\max} - F} \\
    &amp;= K\frac{F - (F_\textrm{rest} - \frac{[L]_\textrm{rest}({F_{\max} - F_\textrm{rest}})}{K})}{F_{\max} - F} \\
    &amp;= \frac{K(F - F_\textrm{rest}) + [L]_\textrm{rest}({F_{\max} - F_\textrm{rest}})}{F_{\max} - F} \\
    &amp;= \frac{[L]_\textrm{rest} + K\frac{F - F_\textrm{rest}}{F_{\max} - F_\textrm{rest}}}{ 1-\frac{F - F_\textrm{rest}}{F_{\max} - F_\textrm{rest}}} \\
\end{align*}
</span></p>
<p>Define <span class="math inline">\frac{\Delta F}{F} := \frac{F-F_\textrm{rest}}{F_\textrm{rest}}</span> and <span class="math inline">(\frac{\Delta F}{F})_{\max} := \frac{F_{\max}-F_\textrm{rest}}{F_\textrm{rest}}</span>. Then we can rewrite <span class="math inline">[L]</span> in terms of these quantities:</p>
<p><span id="eq-ligand-dF"><span class="math display">
\begin{align*}
[L] &amp;= \frac{[L]_\textrm{rest} + K (\frac{\Delta F}{F}) / (\frac{\Delta F}{F})_{\max}}{ 1-(\frac{\Delta F}{F}) / (\frac{\Delta F}{F})_{\max}} \\
\end{align*}
\tag{1.6}</span></span></p>
<p>This equation is of the form <span class="math inline">f(x) = \frac{a + bx}{1-x}</span>. For small <span class="math inline">x</span>, the Taylor series expansion around 0 is <span class="math inline">a+(a+b)x+\mathcal{O}(x)^{2}</span>.</p>
<p>Therefore for small <span class="math inline">(\frac{\Delta F}{F}) / (\frac{\Delta F}{F})_{\max}</span></p>
<p><span id="eq-ligand-dF-approx"><span class="math display">
\begin{align*}
[L] &amp; \approx [L]_\textrm{rest} + ([L]_\textrm{rest} + ({K} / (\frac{\Delta F}{F})_{\max})\frac{\Delta F}{F} \\
\Delta [L] &amp; := [L] - [L]_\textrm{rest} \\
         &amp; \approx ([L]_\textrm{rest} + {K} / (\frac{\Delta F}{F})_{\max})\frac{\Delta F}{F} \\
         &amp; \approx \textrm{constant} \times \frac{\Delta F}{F}
\end{align*}
\tag{1.7}</span></span></p>
<p>The constant has terms <span class="math inline">[L]_\textrm{rest}</span> (depends on cell/region being imaged), <span class="math inline">K</span> (property of the indicator) and <span class="math inline">(\frac{\Delta F}{F})_{\max}</span> (depends on the indicator and optical setup).</p>
</section>
<section id="multiple-indicators" class="level4">
<h4 class="anchored" data-anchor-id="multiple-indicators">Multiple indicators</h4>
<p>For experiments involving one indicator excited by a single laser and measured in a particular region of the emission spectrum, <span class="math inline">\Delta f(t) \propto {\Delta F}/{F}</span> according to <a href="#eq-ligand-F-approx" class="quarto-xref">Equation&nbsp;<span>1.5</span></a> and <a href="#eq-ligand-dF-approx" class="quarto-xref">Equation&nbsp;<span>1.7</span></a>.</p>
<p>With multiple indicators, the fluorescence signal would consist of multiple indicator-specific terms as shown for one indicator in <a href="#eq-single-indicator" class="quarto-xref">Equation&nbsp;<span>1.1</span></a>.</p>
<p>Depending on the emission spectrum of the indicators, the signal at particular <span class="math inline">\lambda</span> would be expected to be dominated by a single indicator. We’ll treat this approach to analyzing the data as a baseline strategy.</p>
</section>
</section>
<section id="autofluorescence" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="autofluorescence"><span class="header-section-number">1.2</span> Autofluorescence</h2>
<p>In calculating <span class="math inline">\Delta F / F</span>, we assumed that the baseline fluorescence signal <span class="math inline">F_\textrm{rest}</span> is only due to a non-zero ligand concentration. Autofluorescence is an important, time dependent source of noise to this end.</p>
<p>The time dependence is related to metabolic activity within cells, which dynamically alters concentration of NADH and FAD molecules. These molecules are considered as the main source of autofluoresence. The excitation and emision spectra for these molecules has been measured in earlier work, see <span class="citation" data-cites="autofluorescencepectra">Hickl co. (<a href="references.html#ref-autofluorescencepectra" role="doc-biblioref">2022</a>)</span> and <span class="citation" data-cites="islam2013ph">Islam et al. (<a href="references.html#ref-islam2013ph" role="doc-biblioref">2013</a>)</span>.</p>
</section>
<section id="isosbestic-control" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="isosbestic-control"><span class="header-section-number">1.3</span> Isosbestic control</h2>
<p>Isosbestic control signal <span class="math inline">I</span> refers to a signal that is independent of the ligand bound fraction <span class="math inline">f</span>. Any variation in <span class="math inline">I</span> can be viewed as noise, and removing components of the signal that are related to <span class="math inline">I</span> would help denoise fiber photometry data, <span class="citation" data-cites="simpson2023lights">Simpson et al. (<a href="references.html#ref-simpson2023lights" role="doc-biblioref">2023</a>)</span>.</p>
<p>Let <span class="math inline">\lambda^{\textrm{exc}}</span> refer to a particular excitation wavelength. From indicator characterization experiments, we have access to the following:</p>
<ol type="1">
<li>Excitation spectrum for the bound state, <span class="math inline">w_\textrm{b}(\lambda^{\textrm{exc}})</span>.</li>
<li>Excitation spectrum for the free state, <span class="math inline">w_\textrm{f}(\lambda^{\textrm{exc}})</span>, <strong>relative to</strong> <span class="math inline">w_\textrm{b}(\lambda^{\textrm{exc}})</span>.</li>
<li>Bound and free states emission spectra <span class="math inline">S_\textrm{b}(\lambda)</span> and <span class="math inline">S_\textrm{f}(\lambda)</span>, normalized so that <span class="math inline">\int{S_\textrm{f}(\lambda) d\lambda} = 1</span> and <span class="math inline">\int{S_\textrm{b}(\lambda) d\lambda} = 1</span>.</li>
</ol>
<p>Consider emission at two distinct wavelengths <span class="math inline">\lambda</span> and <span class="math inline">\lambda'</span> invoked by exciting the sample at <span class="math inline">\lambda_{1}^{\textrm{{exc}}}</span> and <span class="math inline">\lambda_{2}^{\textrm{{exc}}}</span> respectively. Each excitation wavelength corresponds to a different laser <span class="math inline">j</span>:</p>
<p>Following <a href="#eq-single-indicator" class="quarto-xref">Equation&nbsp;<span>1.1</span></a>,</p>
<p><span class="math display">
\begin{align*}
F_{1}(\lambda)  &amp;={f_{\textrm{b}}S_{\textrm{b}}(\lambda)w_{\textrm{b}}(\lambda_{1}^{\textrm{{exc}}})P(\lambda_{1}^{\textrm{{exc}}})}+{(1-f_{\textrm{b}})S_{\textrm{f}}(\lambda)w_{\textrm{f}}(\lambda_{1}^{\textrm{{exc}}})P(\lambda_{1}^{\textrm{{exc}}})} \\
F_{2}(\lambda') &amp;={f_{\textrm{b}}S_{\textrm{b}}(\lambda')w_{\textrm{b}}(\lambda_{2}^{\textrm{{exc}}})P(\lambda_{2}^{\textrm{{exc}}})}+{(1-f_{\textrm{b}})S_{\textrm{f}}(\lambda')w_{\textrm{f}}(\lambda_{2}^{\textrm{{exc}}})P(\lambda_{2}^{\textrm{{exc}}})}
\end{align*}
</span></p>
<p>We make a few notation changes to make things a bit more obvious:</p>
<p><span class="math display">
\begin{align*}
a_{1}   &amp;=S_{\textrm{b}}(\lambda)w_{\textrm{b}}(\lambda_{1}^{\textrm{{exc}}})P(\lambda_{1}^{\textrm{{exc}}}) \\
b_{1}   &amp;=S_{\textrm{f}}(\lambda)w_{\textrm{f}}(\lambda_{1}^{\textrm{{exc}}})P(\lambda_{1}^{\textrm{{exc}}}) \\
a_{2}   &amp;=S_{\textrm{b}}(\lambda')w_{\textrm{b}}(\lambda_{2}^{\textrm{{exc}}})P(\lambda_{2}^{\textrm{{exc}}}) \\
b_{2}   &amp;=S_{\textrm{f}}(\lambda')w_{\textrm{f}}(\lambda_{2}^{\textrm{{exc}}})P(\lambda_{2}^{\textrm{{exc}}}) \\
x(t)    &amp;= f_\textrm{b}(t) \\
y(t)    &amp;= 1-f_\textrm{b}(t) \\
\end{align*}
</span></p>
<p>Then for observations at two different emission wavelengths <span class="math inline">\lambda</span> and <span class="math inline">\lambda'</span>, we have:</p>
<p><span class="math display">
\begin{align*}
F_{1}(\lambda)  &amp;= {x(t)a_{1}}+{y(t)b_{1}} \\
F_{2}(\lambda') &amp;= {x(t)a_{2}}+{y(t)b_{2}} \\
x(t)+y(t)   &amp;= 1 \\
\end{align*}
</span></p>
<p>Consider a linear combination of the observations:</p>
<p><span id="eq-isosbestic-linear-combo"><span class="math display">
mF_{1}(\lambda)+nF_{2}(\lambda')    = x(t)(a_{1}m+a_{2}n)+y(t)(b_{1}m+b_{2}n)
\tag{1.8}</span></span></p>
<p>This would be independent of <span class="math inline">f(t)</span> if and only if <span class="math inline">m</span>, <span class="math inline">n</span> are not both zero, and:</p>
<p><span class="math display">
\begin{align*}
a_{1}m+a_{2}n   &amp;= b_{1}m+b_{2}n \\
\end{align*}
</span></p>
<p>Then the condition for such a linear combination to be considered as the isosbestic control signal is:</p>
<p><span id="eq-isosbestic-coeff-ratio"><span class="math display">
\frac{m}{n} = \frac{b_2-a_2}{a_1-b_1} =\frac{S_{\textrm{f}}(\lambda')w_{\textrm{f}}(\lambda_{2}^{\textrm{{exc}}})P(\lambda_{2}^{\textrm{{exc}}})-S_{\textrm{b}}(\lambda')w_{\textrm{b}}(\lambda_{2}^{\textrm{{exc}}})P(\lambda_{2}^{\textrm{{exc}}})}{S_{\textrm{b}}(\lambda)w_{\textrm{b}}(\lambda_{1}^{\textrm{{exc}}})P(\lambda_{1}^{\textrm{{exc}}})-S_{\textrm{f}}(\lambda)w_{\textrm{f}}(\lambda_{1}^{\textrm{{exc}}})P(\lambda_{1}^{\textrm{{exc}}})}
\tag{1.9}</span></span></p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Special cases to obtain an isosbestic control signal
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>Experimental setups may present various constraints. Here we consider three such special cases.</p>
<p><strong>Case I</strong></p>
<p>There are two excitation lasers, <span class="math inline">\lambda_1^{\textrm{{exc}}}</span> and <span class="math inline">\lambda_2^{\textrm{{exc}}}</span>. Assuming that emission spectra of the bound and <strong>free</strong> states are the same, i.e.&nbsp;<span class="math inline">S_{\textrm{f}}=S_{\textrm{b}}=S</span>. Then based on <a href="#eq-isosbestic-linear-combo" class="quarto-xref">Equation&nbsp;<span>1.8</span></a> and <a href="#eq-isosbestic-coeff-ratio" class="quarto-xref">Equation&nbsp;<span>1.9</span></a>:</p>
<p><span class="math display">
\frac{m}{n} = \frac{S(\lambda')P(\lambda_{2}^{\textrm{{exc}}})[w_{\textrm{f}}(\lambda_{2}^{\textrm{{exc}}})-w_{\textrm{b}}(\lambda_{2}^{\textrm{{exc}}})]}{S(\lambda)P(\lambda_{1}^{\textrm{{exc}}})[w_{\textrm{b}}(\lambda_{1}^{\textrm{{exc}}})-w_{\textrm{f}}(\lambda_{1}^{\textrm{{exc}}})]}
</span></p>
<p>Choosing <span class="math inline">m</span> and <span class="math inline">n</span> as exactly the numerator and denominator and defining <span class="math inline">\kappa = S(\lambda)P(\lambda_{1}^{\textrm{{exc}}})S(\lambda')P(\lambda_{2}^{\textrm{{exc}}})</span>: <span class="math display">mF_{1}(\lambda)+nF_{2}(\lambda') = \kappa[w_{\textrm{b}}(\lambda_{1}^{\textrm{exc}})w_{\textrm{f}}(\lambda_{2}^{\textrm{exc}})-w_{\textrm{b}}(\lambda_{2}^{\textrm{exc}})w_{\textrm{f}}(\lambda_{1}^{\textrm{exc}})]</span></p>
<p>This is a non-zero signal that is independent of <span class="math inline">f(t)</span>, which can provide information on noise factors for such experiments.</p>
<p><strong>Case II</strong></p>
<p>There is a single excitation laser, <span class="math inline">\lambda^{\textrm{{exc}}}</span>, emission spectra of the bound and free states are the same, and there is only one observed emission wavelength. In this scenario, typically there is a dedicated laser to obtain the isosbestic control signal, for which the wavelength needs to be picked based on indicator properties.</p>
<p><a href="#eq-single-indicator" class="quarto-xref">Equation&nbsp;<span>1.1</span></a> suggests that for <span class="math inline">F</span> to be independent of <span class="math inline">f</span>, we need <span class="math inline">w_\textrm{b}(\lambda^{\textrm{{exc}}}) = w_\textrm{f}(\lambda^{\textrm{{exc}}})</span>, and for excitation by this laser, any emission wavelength <span class="math inline">\lambda</span> can serve as the isosbestic control.</p>
<p><strong>Case III</strong></p>
<p>If there is just a single excitation laser, signals <span class="math inline">F_1(\lambda)</span> and <span class="math inline">F_2(\lambda')</span> are simply scalar multiples of one another. Under the assumption <span class="math inline">S_\textrm{f}=S_\textrm{b}=S</span> there is no additional information to be gained from the second measurement under our model.</p>
</div>
</div>
</div>
<p>Signals obtained <em>in vivo</em> will also contain other, additive sources (e.g.&nbsp;autofluoresence and other other signals from other indicators, if present). We’ve ignored those in the above analysis. We also implicitly set <span class="math inline">C(t)</span> to 1 everywhere - thus ignoring the effect of bleaching. Both bleaching and hemodynamics are multiplicative effects, which will persist in the isosbestic signal.</p>
<p>Motion-related artifacts are a common source of noise in fiber photometry experiments. Motion (e.g.&nbsp;head movements) disturbs the optical path (e.g.&nbsp;bending of the fiber), and typically attenuates the signal. This is a multiplicative effect which also affects the isosbestic control signal. Regressing out the component common to the isosbestic control signal and the indicator signal can reduce severity of this artifact, see <span class="citation" data-cites="simpson2023lights">Simpson et al. (<a href="references.html#ref-simpson2023lights" role="doc-biblioref">2023</a>)</span> for an overview and <span class="citation" data-cites="keevers2023obtaining">Keevers, McNally, and Jean-Richard-dit-Bressel (<a href="references.html#ref-keevers2023obtaining" role="doc-biblioref">2023</a>)</span> for an implementation of such a procedure.</p>
<p><span class="citation" data-cites="creamer2022correcting">Creamer et al. (<a href="references.html#ref-creamer2022correcting" role="doc-biblioref">2022</a>)</span> discuss motion-related artifacts in a different system but may provide inspiration for solutions in mouse fiber photometry experiments.</p>
</section>
<section id="sec-hemodynamics" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="sec-hemodynamics"><span class="header-section-number">1.4</span> Hemodynamics</h2>
<p>Absorption by hemoglobin corrupts the signal. For <em>in vivo</em> measurements, the total cerebral blood volume, and fraction of oxygenated to deoxygenated hemoglobin are dynamic quantities. Oxygenated and deoxygenated hemoglobin have different absorption spectra. The Beer-Lambert law can used to model this effect in the generative model above. A similar approach is considered in <span class="citation" data-cites="zhang2022spectral">Zhang et al. (<a href="references.html#ref-zhang2022spectral" role="doc-biblioref">2022</a>)</span>.</p>
<p>Previous work in <span class="citation" data-cites="ma2016wide">Ma et al. (<a href="references.html#ref-ma2016wide" role="doc-biblioref">2016</a>)</span> may also be relevant to this problem.</p>
<ul>
<li><span class="math inline">\varepsilon</span>: extinction coefficient (in <span class="math inline">{\textrm{cm}}^{-1}{\textrm{mole}}^{-1}{L}</span>), see <span class="citation" data-cites="hemoglobinspectra">Prahl (<a href="references.html#ref-hemoglobinspectra" role="doc-biblioref">1998</a>)</span>. This is a function of <span class="math inline">\lambda</span></li>
<li><span class="math inline">h</span>: concentration (100 to 200 <span class="math inline">gL^{-1}</span> for Hemoglobin in brain, is a function of time, and linked to brain region-specific neuron activity</li>
<li><span class="math inline">l</span>: effective cuvette length in the Beer-Lambert law. We set this to 1 <span class="math inline">\textrm{cm}</span>, and assume no dependence on <span class="math inline">\lambda</span> here.</li>
<li><span class="math inline">M_{\textrm{Hb}}</span>: molar mass of Hemoglobin = 64,500 <span class="math inline">g\textrm{mole}^{-1}</span></li>
<li><span class="math inline">A</span>: absorbance, calculated as per Beer-Lambert’s law <span class="math inline">A = \frac{\varepsilon \times h \times {l}}{M_{\textrm{Hb}}}</span></li>
<li>Let <span class="math inline">f(t)</span> be fraction of hemoglobin in the oxygenated state. Define <span class="math inline">h_{\textrm{HbO}}</span>, <span class="math inline">h_{\textrm{HbR}}</span>, <span class="math inline">\mu_{\textrm{HbO}}</span> and <span class="math inline">\mu_{\textrm{HbR}}</span> as:</li>
</ul>
<p><span class="math display">
\begin{align*}
h_\textrm{HbO}(t) &amp;= f(t)h_{\textrm{HbT}}(t) \\
h_\textrm{HbR}(t) &amp;= (1 - f(t))h_{\textrm{HbT}}(t) \\
\mu_\textrm{HbO}(\lambda) &amp;= \tfrac{\varepsilon_{\textrm{HbO}}(\lambda)}{M_{\textrm{Hg}}} \\
\mu_\textrm{HbR}(\lambda) &amp;= \tfrac{\varepsilon_{\textrm{HbR}}(\lambda)}{M_{\textrm{Hg}}}
\end{align*}
</span></p>
<ul>
<li>Replacing <span class="math inline">A</span> in the definition of absorbance: <span class="math inline">\frac{I}{I_o} = e^{-A}</span>: <span class="math display">
I(\lambda, t) = I_o(\lambda, t) e^{-(\mu_{\textrm{HbO}}(\lambda)h_{\textrm{HbO}}(t) + \mu_{\textrm{HbR}}(\lambda)h_{\textrm{HbR}}(t))}
</span></li>
</ul>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Approach in <span class="citation" data-cites="zhang2022spectral">Zhang et al. (<a href="references.html#ref-zhang2022spectral" role="doc-biblioref">2022</a>)</span>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>As in <a href="#eq-single-indicator" class="quarto-xref">Equation&nbsp;<span>1.1</span></a>, fluorescence is modeled as linearly proportional to indicator concentration. Assuming the bound state fraction is the same across time (e.g.&nbsp;in a dead-sensor experiment), ratio of fluorescence measurements at any time <span class="math inline">t</span> relative to reference time <span class="math inline">t_0</span> in the absence of any absorption:</p>
<p><span class="math display">
\frac{F(t)}{F(t_0)} = \frac{C(t)}{C(t_0)}
</span></p>
<p>Absorption is considered along the path followed by the excitation light, and the path followed by the emission light. In <a href="#eq-single-indicator" class="quarto-xref">Equation&nbsp;<span>1.1</span></a>, this amounts to multiplying the incident power by a factor related to the first path, and the overall emission by another factor.</p>
<p><span class="math display">
\begin{align*}
\frac{F(t,\lambda)}{F(t_{0},\lambda)}&amp;=e^{-\Delta\mu(\lambda)\chi(\lambda)}e^{-\Delta\mu(\lambda_{{\textrm{exc}}})\chi(\lambda_{{\textrm{exc}}})}\frac{C(t)}{C(t_{0})} \\
\log\frac{F(t,\lambda)}{F(t_{0},\lambda)}&amp;=-\Delta\mu(\lambda)\chi(\lambda)-\Delta\mu(\lambda_{{\textrm{exc}}})\chi(\lambda_{{\textrm{exc}}})+\log(\frac{C(t)}{C(t_{0})})
\end{align*}
</span></p>
<p>The first two terms on the right hand side can be written in terms of contributions from HbO and HbR: <span class="math display">
\begin{align*}
\Delta\mu(\lambda)\chi(\lambda)+\Delta\mu(\lambda_{{\textrm{exc}}})\chi(\lambda_{{\textrm{exc}}})=&amp; \Delta C_{{\textrm{HbO}}}(t)[\xi_{{\textrm{HbO}}}(\lambda)+\xi_{{\textrm{HbO}}}(\lambda_{{\textrm{exc}}})] \\
&amp;+\Delta C_{{\textrm{HbR}}}(t)[\xi_{{\textrm{HbR}}}(\lambda)+\xi_{{\textrm{HbR}}}(\lambda_{{\textrm{exc}}})]
\end{align*}
</span></p>
<p>Compared to notation in <a href="#sec-hemodynamics" class="quarto-xref"><span>Section 1.4</span></a>, here we use:</p>
<ul>
<li><span class="math inline">\xi_{{\textrm{HbO}}} \equiv \varepsilon_{\textrm{HbO}} / M_{\textrm{Hg}}</span>, <span class="math inline">\xi_{{\textrm{HbR}}} \equiv \varepsilon_{\textrm{HbR}} / M_{\textrm{Hg}}</span></li>
<li><span class="math inline">\chi(\lambda) \equiv l</span> (previously assumed to be fixed (1 cm) for all <span class="math inline">\lambda</span>)</li>
<li><span class="math inline">C_\textrm{HbO}(t) \equiv h_{\textrm{HbO}}(t)</span>, <span class="math inline">C_\textrm{HbR}(t) \equiv h_{\textrm{HbR}}(t)</span>, <span class="math inline">C_\textrm{HbT}(t) \equiv h_{\textrm{HbT}}(t)</span></li>
</ul>
<p>Consider that emission is measured at <span class="math inline">n</span> different wavelengths, indexed by <span class="math inline">i</span>. Define the following terms:</p>
<p><span class="math display">
\begin{align*}
M_i(t) &amp;= \log\left(\frac{F(t, \lambda_{i})}{F(0, \lambda_{i})}\right) \\
A_i    &amp;= \xi_{\textrm{HbO}}(\lambda_{\textrm{exc}})\chi(\lambda_{{\textrm{exc}}}) +
          \xi_{\textrm{HbO}}(\lambda_{i})\chi(\lambda_{i}) \\
B_i    &amp;= \xi_{\textrm{HbR}}(\lambda_{\textrm{exc}})\chi(\lambda_{{\textrm{exc}}}) +
          \xi_{\textrm{HbR}}(\lambda_{i})\chi(\lambda_{i})
\end{align*}
</span></p>
<p>If the indicator is known to be activity-independent (i.e.&nbsp;a dead-sensor experiment), then authors propose that change in fluorescence can be attributed primarily to hemodynamics, and therefore <span class="math inline">\log \frac{C(t)}{C(0)} \approx 0</span>.</p>
<p>Authors propose solving the following optimization problem at each time step (with generalized method of moments) to estimate <span class="math inline">\Delta C_{{\textrm{HbO}}}(t)</span> and <span class="math inline">\Delta C_{{\textrm{HbR}}}(t)</span>, with <span class="math inline">\sigma(t)</span> included as an additional parameter. <span class="math display">
\underset{\Delta C_{{\textrm{HbO}}}(t),\Delta C_{{\textrm{HbR}}}(t),\sigma(t)}{\textrm{argmin}} \sum_{i=1}^{n} [M(t)_i + \Delta C_{{\textrm{HbO}}}(t) A_i + \Delta C_{{\textrm{HbR}}}(t) B_i - \sigma(t)) ]^2
</span></p>
<p>In any <em>in vivo</em> experiment, this will be confounded by time-dependent autofluoresence. In our setup, we have multiple values for <span class="math inline">\lambda_{\textrm{exc}}</span> as well. There is flexibility in choosing <span class="math inline">t_0</span> as well.</p>
</div>
</div>
</div>
</section>
<section id="blooming-and-notch-filters" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="blooming-and-notch-filters"><span class="header-section-number">1.5</span> Blooming and notch filters</h2>
<p>Large power incident at any particular camera pixel can saturate that pixel, and also cause a spill-over effect at neighboring pixels referred to as blooming.</p>
<p>For measurements where the camera pixels correspond to different emission wavelengths, the problem is particularly severe around the value of the excitation laser wavelength.</p>
<p>Notch filters can be used to attenuate the signal at particular wavelengths on it’s way back from the brain to the camera.</p>
<hr>
</section>
<section id="previous-approach-to-modeling-the-signal" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="previous-approach-to-modeling-the-signal"><span class="header-section-number">1.6</span> Previous approach to modeling the signal</h2>
<p><span id="eq-observation"><span class="math display">
\begin{align}
O(t,\lambda,j) &amp;= [ \left( \sum_{i \in \{\textrm{I},\textrm{AF}\}}{a(i,t) s(i,\lambda) w(i,j)} \right) H(t, \lambda) m(t) + b(\lambda,j) ] n(t,j) \\
H(t, \lambda) &amp;= e^{-(\mu_{\textrm{HbO}(\lambda)}h_{\textrm{HbO}}(t) + \mu_{\textrm{HbR}(\lambda)}h_{\textrm{HbR}}(t))}
\end{align}
\tag{1.10}</span></span></p>
<ul>
<li><span class="math inline">a(i,t)</span> for <span class="math inline">i \in \textrm{I}</span> has fast and slow components</li>
<li><span class="math inline">a(t) = c\{f(t)s_\textrm{bound}(\lambda) + (1-f(t))s_\textrm{free}(\lambda)\}</span> : an indicator with concentration <span class="math inline">c</span> exists in two states (e.g.&nbsp;bright, dark or bound, free) that have their own emission spectra.</li>
<li>Isosbestic point is the particular <span class="math inline">\lambda</span> where the two populations cannot be distinguished. This does not always exist for all indicators, but when it does exist it might be possible to use it for corrections related to Hemodynamics, see <span class="citation" data-cites="zhang2022spectral">Zhang et al. (<a href="references.html#ref-zhang2022spectral" role="doc-biblioref">2022</a>)</span></li>
<li><span class="math inline">h_{\textrm{HbO}}(t), h_{\textrm{HbR}}(t)</span> : Blood concentration of oxygenated and deoxygenated hemoglobin over time</li>
<li><span class="math inline">a(i,t)</span> is multiplied by a decay term <span class="math inline">d(i,t)</span> associated with bleaching. <span class="math inline">d(i,t) = d_\textrm{fast}(i)e^{-\frac{t}{\tau_\textrm{fast}}} + d_\textrm{slow}(i)e^{-\frac{t}{\tau_\textrm{slow}}} + d_\textrm{constant}(i)</span></li>
</ul>
</section>
<section id="experiment-proposals" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="experiment-proposals"><span class="header-section-number">1.7</span> Experiment proposals</h2>
<p>(Under development)</p>
<ol type="1">
<li>Dead sensor experiment: Fluorescence would be independent of neuron activity. Autofluoresence and hemodynamics would be present. Fluctuation in indicator signal could be attributed to motion, hemodynamics, bleaching. Utility: validation of <span class="math inline">F_0</span> estimation, bleaching correction, motion correction.<br>
</li>
<li>Triggered activity experiment: Activity could be treated as known. Activity-dependent hemodynamic effects could also be considered as known, and used to validate hemodynamic fit.</li>
<li>Direct blood volume measurements as in <span class="citation" data-cites="zhang2022spectral">Zhang et al. (<a href="references.html#ref-zhang2022spectral" role="doc-biblioref">2022</a>)</span>.
<ul>
<li>EYFP expressed in primary somatosensory cortex (using AAV) of the forelimb region.</li>
<li>Intravenously administered Rhodamine B for CBV measurements.</li>
<li>Electrical stimulation of the contralateral forepaw to trigger activity.</li>
</ul></li>
</ol>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-creamer2022correcting" class="csl-entry" role="listitem">
Creamer, Matthew S, Kevin S Chen, Andrew M Leifer, and Jonathan W Pillow. 2022. <span>“Correcting Motion Induced Fluorescence Artifacts in Two-Channel Neural Imaging.”</span> <em>PLoS Computational Biology</em> 18 (9): e1010421.
</div>
<div id="ref-grynkiewicz1985new" class="csl-entry" role="listitem">
Grynkiewicz, Grzegorz, Martin Poenie, and Roger Y Tsien. 1985. <span>“A New Generation of Ca2+ Indicators with Greatly Improved Fluorescence Properties.”</span> <em>Journal of Biological Chemistry</em> 260 (6): 3440–50.
</div>
<div id="ref-helmchen2011calibration" class="csl-entry" role="listitem">
Helmchen, Fritjof. 2011. <span>“Calibration Protocols for Fluorescent Calcium Indicators.”</span> <em>Cold Spring Harbor Protocols</em> 2011 (8): 980–84.
</div>
<div id="ref-autofluorescencepectra" class="csl-entry" role="listitem">
Hickl co., Becker &amp;. 2022. <span>“Autofluorescence Spectra.”</span> <span class="smallcaps">url:</span>&nbsp;<a href="https://www.becker-hickl.com/applications/metabolic-imaging/#application-principles" class="uri">https://www.becker-hickl.com/applications/metabolic-imaging/#application-principles</a>.
</div>
<div id="ref-islam2013ph" class="csl-entry" role="listitem">
Islam, Md Serajul, Masato Honma, Takakazu Nakabayashi, Masataka Kinjo, and Nobuhiro Ohta. 2013. <span>“pH Dependence of the Fluorescence Lifetime of FAD in Solution and in Cells.”</span> <em>International Journal of Molecular Sciences</em> 14 (1): 1952–63.
</div>
<div id="ref-keevers2023obtaining" class="csl-entry" role="listitem">
Keevers, Luke J, Gavan P McNally, and Philip Jean-Richard-dit-Bressel. 2023. <span>“Obtaining Artifact-Corrected Signals in Fiber Photometry: Isosbestic Signals, Robust Regression and dF/f Calculations.”</span>
</div>
<div id="ref-ma2016wide" class="csl-entry" role="listitem">
Ma, Ying, Mohammed A Shaik, Sharon H Kim, Mariel G Kozberg, David N Thibodeaux, Hanzhi T Zhao, Hang Yu, and Elizabeth MC Hillman. 2016. <span>“Wide-Field Optical Mapping of Neural Activity and Brain Haemodynamics: Considerations and Novel Approaches.”</span> <em>Philosophical Transactions of the Royal Society B: Biological Sciences</em> 371 (1705): 20150360.
</div>
<div id="ref-hemoglobinspectra" class="csl-entry" role="listitem">
Prahl, Scott. 1998. <span>“Optical Spectra of Hemoglobin.”</span> <span class="smallcaps">url:</span>&nbsp;<a href="https://omlc.org/spectra/hemoglobin/summary.html" class="uri">https://omlc.org/spectra/hemoglobin/summary.html</a>.
</div>
<div id="ref-simpson2023lights" class="csl-entry" role="listitem">
Simpson, Eleanor H, Thomas Akam, Tommaso Patriarchi, Marta Blanco-Pozo, Lauren M Burgeno, Ali Mohebi, Stephanie J Cragg, and Mark E Walton. 2023. <span>“Lights, Fiber, Action! A Primer on in Vivo Fiber Photometry.”</span> <em>Neuron</em>.
</div>
<div id="ref-zhang2022spectral" class="csl-entry" role="listitem">
Zhang, Wei-Ting, Tzu-Hao Harry Chao, Yue Yang, Tzu-Wen Wang, Sung-Ho Lee, Esteban A Oyarzabal, Jingheng Zhou, et al. 2022. <span>“Spectral Fiber Photometry Derives Hemoglobin Concentration Changes for Accurate Measurement of Fluorescent Sensor Activity.”</span> <em>Cell Reports Methods</em> 2 (7): 100243.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link" aria-label="Preface">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Preface</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./01_methods.html" class="pagination-link" aria-label="Methods">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Methods</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>
