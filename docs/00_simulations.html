<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Source separation - 1&nbsp; Simulating hyperspectral fiber photometry signals</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./01_methods.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./00_simulations.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Simulating hyperspectral fiber photometry signals</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Source separation</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_simulations.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Simulating hyperspectral fiber photometry signals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#signal-from-indicators" id="toc-signal-from-indicators" class="nav-link active" data-scroll-target="#signal-from-indicators"><span class="header-section-number">1.1</span> Signal from indicators</a></li>
  <li><a href="#previous-approach-to-modeling-the-signal" id="toc-previous-approach-to-modeling-the-signal" class="nav-link" data-scroll-target="#previous-approach-to-modeling-the-signal"><span class="header-section-number">1.2</span> Previous approach to modeling the signal</a></li>
  <li><a href="#model-for-hemodynamics" id="toc-model-for-hemodynamics" class="nav-link" data-scroll-target="#model-for-hemodynamics"><span class="header-section-number">1.3</span> Model for hemodynamics</a></li>
  <li><a href="#autofluorescence-1" id="toc-autofluorescence-1" class="nav-link" data-scroll-target="#autofluorescence-1"><span class="header-section-number">1.4</span> Autofluorescence</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Simulating hyperspectral fiber photometry signals</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>A recap of the basic model for fluorescence signals from protein indicators</p>
<section id="signal-from-indicators" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="signal-from-indicators"><span class="header-section-number">1.1</span> Signal from indicators</h2>
<p><span class="math display">
\def\lexc{\lambda^{\dagger}_{j}}
\gdef\colA#1{\textcolor{6488EA}{#1}}
\gdef\colB#1{\textcolor{AA2704}{#1}}
</span></p>
<section id="assumptions-caveats" class="level4">
<h4 class="anchored" data-anchor-id="assumptions-caveats">Assumptions / caveats</h4>
<ul>
<li>We may ignore spatial variation (e.g.&nbsp;related to illumination/ detection)</li>
<li>We may assume bound fraction is small (<span class="math inline">f \ll 1</span>)</li>
<li>We may assume that <span class="math inline">\frac{\Delta F}{F} \ll (\frac{\Delta F}{F})_\textrm{max}</span></li>
</ul>
</section>
<section id="indicator-bleaching" class="level4">
<h4 class="anchored" data-anchor-id="indicator-bleaching">Indicator bleaching</h4>
<p>The total number of indicator molecules that can fluoresce reduces over time and this is referred to as bleaching. Here we model bleaching as a sum of exponentials, one with a fast time constant and one with a slow time constant. <span class="math display">C(t) = C_\textrm{slow} e^{-\frac{t}{\tau_\textrm{slow}}} + C_\textrm{fast} e^{-\frac{t}{\tau_\textrm{fast}}}</span></p>
</section>
<section id="indicator-signal" class="level4">
<h4 class="anchored" data-anchor-id="indicator-signal">Indicator signal</h4>
<p>The fluorescing indicator molecules can exist in one of two states, bound to ligand or free. Let the fraction of the bound indicator be <span class="math inline">f_{\textrm{b}}(t)</span>. Assuming emission spectra <span class="math inline">S_\textrm{b}(\lambda)</span> and <span class="math inline">S_\textrm{f}(\lambda)</span> for the different indicator states, power of the <span class="math inline">j</span><sup>th</sup> laser <span class="math inline">P(j,t)</span>, and efficiency of the laser to excite populations <span class="math inline">w_\textrm{b}(j)</span> and <span class="math inline">w_\textrm{f}(j)</span>, the fluorescence readout <span class="math inline">F(t,\lambda,j)</span> is modeled as:</p>
<p><span id="eq-single-indicator"><span class="math display">
\begin{align*}
F(t,\lambda,j) = &amp; \colA{f_{\textrm{b}}(t) S_\textrm{b}(\lambda)w_\textrm{b}(j) C(t) P(j,t)} + \\
                 &amp; \colB{(1 - f_{\textrm{b}}(t)) S_\textrm{f}(\lambda)w_\textrm{f}(j) C(t) P(j,t)}
\end{align*}
\tag{1.1}</span></span></p>
<p><a href="#eq-single-indicator">Equation&nbsp;<span>1.1</span></a> is analogous to the setup in and in <span class="citation" data-cites="helmchen2011calibration">Helmchen (<a href="references.html#ref-helmchen2011calibration" role="doc-biblioref">2011</a>)</span>. In the following, we’ll refer to <span class="math inline">f_{\textrm{b}}</span> as simply <span class="math inline">f</span>. Assuming a positive indicator (where the bound state is brighter than free state), define <span class="math inline">F_{\max}</span> and <span class="math inline">F_{\min}</span> as the signal when <span class="math inline">f=0</span> and <span class="math inline">f=1</span> respectively. We’ll pack terms other than <span class="math inline">f</span> in <a href="#eq-single-indicator">Equation&nbsp;<span>1.1</span></a> into <span class="math inline">\eta_\textrm{b}</span> and <span class="math inline">\eta_\textrm{f}</span> for the bound and free components and also drop the arguments for <span class="math inline">t</span>, <span class="math inline">\lambda</span>, <span class="math inline">j</span> for now. Then:</p>
<p><span id="eq-bound-fraction"><span class="math display">
\begin{align*}
F &amp;= \eta_{\textrm{b}}f + \eta_{\textrm{f}}(1-f)\\
  &amp;= F_{\min} + (\eta_{\textrm{b}} − \eta_{\textrm{f}})f \\
  &amp;= F_{\max} − (\eta_{\textrm{b}} − \eta_{\textrm{f}})(1-f) \\
\implies \frac{f}{1-f} &amp;= \frac{F - F_{\min}}{F_{\max} - F} \\
\end{align*}
\tag{1.2}</span></span></p>
<p>Defining <span class="math inline">R := {F_{\max}}/{F_{\min}}</span>, we can rewrite <a href="#eq-bound-fraction">Equation&nbsp;<span>1.2</span></a> as: <span id="eq-bound-fraction-rel"><span class="math display">
\frac{f}{1-f} = \frac{F / F_{\max} − 1 / R}{1 − F / F_{\max}}
\tag{1.3}</span></span></p>
<p><a href="#eq-bound-fraction-rel">Equation&nbsp;<span>1.3</span></a> is only contains ratios of fluorosence; these terms are invariant to indicator concentration (assuming it is non-zero), and laser power as in <a href="#eq-single-indicator">Equation&nbsp;<span>1.1</span></a></p>
</section>
<section id="relating-ligand-concentration-to-fluorescence" class="level4">
<h4 class="anchored" data-anchor-id="relating-ligand-concentration-to-fluorescence">Relating ligand concentration to fluorescence</h4>
<p>This section is based on discussions in <span class="citation" data-cites="helmchen2011calibration">Helmchen (<a href="references.html#ref-helmchen2011calibration" role="doc-biblioref">2011</a>)</span> and <span class="citation" data-cites="grynkiewicz1985new">Grynkiewicz, Poenie, and Tsien (<a href="references.html#ref-grynkiewicz1985new" role="doc-biblioref">1985</a>)</span> to relate observed signal to ligand (<span class="math inline">\textrm{Ca}^{2+}</span> in these studies) concentration in imaging experiments.</p>
<p>For indicator protein <span class="math inline">P</span> and the ligand <span class="math inline">L</span>, assumiing 1:1 complexation (i.e.&nbsp;1 molecule of <span class="math inline">P</span> binds to 1 molecule of <span class="math inline">L</span>):</p>
<p><span class="math display">
L + P \xrightleftharpoons[k_{d}]{k_{a}} LP
</span></p>
<p>At equillibrium: <span class="math display">
k_d[LP] = k_a[L][P]
</span></p>
<p>The dissociation constant <span class="math inline">K</span> is defined as <span class="math inline">\frac{k_d}{k_a}</span>:</p>
<p><span class="math display">
K = \frac{[L][P]}{[LP]} \qquad [P] = \frac{K[LP]}{[L]}
</span></p>
<p>The fraction of bound indicator <span class="math inline">f</span>: <span class="math display">
f = \frac{[LP]}{[P] + [LP]}
= \frac{[L]}{K + [L]}
</span></p>
<p>Then <span class="math inline">[L]</span> can be expressed as a function of <span class="math inline">f</span>, and using <a href="#eq-bound-fraction">Equation&nbsp;<span>1.2</span></a>, we relate the ligand concentration to the observed fluoresence signal. <span id="eq-ligand-F"><span class="math display">
[L] = K\frac{f}{1-f} = K\frac{F - F_{\min}}{F_{\max} - F} = K\frac{F / F_{\max} − 1 / R}{1 − F / F_{\max}}
\tag{1.4}</span></span></p>
<p>As a further simplification, for <span class="math inline">f \ll 1</span> (Taylor expansion of <span class="math inline">\frac{f}{1-f}</span> around <span class="math inline">f=0</span>)</p>
<p><span id="eq-ligand-F-approx"><span class="math display">
[L] \approx Kf
\tag{1.5}</span></span></p>
</section>
<section id="relating-ligand-concentration-to-delta-f-f" class="level4">
<h4 class="anchored" data-anchor-id="relating-ligand-concentration-to-delta-f-f">Relating ligand concentration to <span class="math inline">\Delta F / F</span></h4>
<p>Measuring <span class="math inline">F_{\min}</span> can be a problem, because of the presence of a baseline ligand concentration <span class="math inline">[L]_\textrm{rest}</span>, which is associated with a baseline fluorescence signal <span class="math inline">F_\textrm{rest}</span>. Using the equation derived in the section above:</p>
<p><span class="math display">
\begin{align*}
[L]_\textrm{rest} &amp;= K\frac{F_\textrm{rest} - F_{\min}}{F_{\max} - F_\textrm{rest}}  \\
F_{\min} &amp;= F_\textrm{rest} - \frac{[L]_\textrm{rest}({F_{\max} - F_\textrm{rest}})}{K}   \\
\end{align*}
</span></p>
<p>Replace <span class="math inline">F_{\min}</span> in the expression for <span class="math inline">[L]</span>:</p>
<p><span class="math display">
\begin{align*}
[L] &amp;= K\frac{F - F_{\min}}{F_{\max} - F} \\
    &amp;= K\frac{F - (F_\textrm{rest} - \frac{[L]_\textrm{rest}({F_{\max} - F_\textrm{rest}})}{K})}{F_{\max} - F} \\
    &amp;= \frac{K(F - F_\textrm{rest}) + [L]_\textrm{rest}({F_{\max} - F_\textrm{rest}})}{F_{\max} - F} \\
    &amp;= \frac{[L]_\textrm{rest} + K\frac{F - F_\textrm{rest}}{F_{\max} - F_\textrm{rest}}}{ 1-\frac{F - F_\textrm{rest}}{F_{\max} - F_\textrm{rest}}} \\
\end{align*}
</span></p>
<p>Define <span class="math inline">\frac{\Delta F}{F} := \frac{F-F_\textrm{rest}}{F_\textrm{rest}}</span> and <span class="math inline">(\frac{\Delta F}{F})_{\max} := \frac{F_{\max}-F_\textrm{rest}}{F_\textrm{rest}}</span>. Then we can rewrite <span class="math inline">[L]</span> in terms of these quantities:</p>
<p><span id="eq-ligand-dF"><span class="math display">
\begin{align*}
[L] &amp;= \frac{[L]_\textrm{rest} + K (\frac{\Delta F}{F}) / (\frac{\Delta F}{F})_{\max}}{ 1-(\frac{\Delta F}{F}) / (\frac{\Delta F}{F})_{\max}} \\
\end{align*}
\tag{1.6}</span></span></p>
<p>This equation is of the form <span class="math inline">f(x) = \frac{a + bx}{1-x}</span>. For small <span class="math inline">x</span>, the Taylor series expansion around 0 is <span class="math inline">a+(a+b)x+\mathcal{O}(x)^{2}</span>.</p>
<p>Therefore for small <span class="math inline">(\frac{\Delta F}{F}) / (\frac{\Delta F}{F})_{\max}</span></p>
<p><span id="eq-ligand-dF-approx"><span class="math display">
\begin{align*}
[L] &amp; \approx [L]_\textrm{rest} + ([L]_\textrm{rest} + ({K} / (\frac{\Delta F}{F})_{\max})\frac{\Delta F}{F} \\
\Delta [L] &amp; := [L] - [L]_\textrm{rest} \\
         &amp; \approx ([L]_\textrm{rest} + {K} / (\frac{\Delta F}{F})_{\max})\frac{\Delta F}{F} \\
         &amp; \approx \textrm{constant} \times \frac{\Delta F}{F}
\end{align*}
\tag{1.7}</span></span></p>
<p>The constant has terms <span class="math inline">[L]_\textrm{rest}</span> (depends on cell/region being imaged), <span class="math inline">K</span> (property of the indicator) and <span class="math inline">(\frac{\Delta F}{F})_{\max}</span> (depends on the indicator and optical setup).</p>
</section>
<section id="multiple-indicators" class="level4">
<h4 class="anchored" data-anchor-id="multiple-indicators">Multiple indicators</h4>
<p>For experiments involving one indicator excited by a single laser and measured in a particular region of the emission spectrum <span class="math inline">f(t) \propto {\Delta F}{F} \propto</span> according to <a href="#eq-ligand-F-approx">Equation&nbsp;<span>1.5</span></a> and <a href="#eq-ligand-dF-approx">Equation&nbsp;<span>1.7</span></a>.</p>
<p>With multiple indicators, the fluorescence signal would consist of multiple indicator-specific terms as shown for one indicator in <a href="#eq-single-indicator">Equation&nbsp;<span>1.1</span></a>.</p>
<p>Depending on the emission spectrum of the indicators, the signal at particular <span class="math inline">\lambda</span> would be expected to be dominated by a single indicator. We’ll treat this approach to analyzing the data as a baseline strategy.</p>
</section>
<section id="autofluorescence" class="level4">
<h4 class="anchored" data-anchor-id="autofluorescence">Autofluorescence</h4>
<p>In calculating <span class="math inline">\Delta F / F</span>, we assumed that the baseline fluorescence signal <span class="math inline">F_\textrm{rest}</span> is only due to a non-zero ligand concentration. Autofluorescence is an important source of noise to this end.</p>
</section>
<section id="motion-artifacts" class="level4">
<h4 class="anchored" data-anchor-id="motion-artifacts">Motion artifacts</h4>
<ul>
<li>Isosbestic control measurement</li>
<li>Motion correction approach with a reference e.g. <span class="citation" data-cites="bridge2023fipha">Bridge et al. (<a href="references.html#ref-bridge2023fipha" role="doc-biblioref">2023</a>)</span>, <span class="citation" data-cites="creamer2022correcting">Creamer et al. (<a href="references.html#ref-creamer2022correcting" role="doc-biblioref">2022</a>)</span>.</li>
</ul>
</section>
<section id="blooming" class="level4">
<h4 class="anchored" data-anchor-id="blooming">Blooming</h4>
<p>Camera blooming effect + notch filters to offset that</p>
</section>
<section id="patch-cord" class="level4">
<h4 class="anchored" data-anchor-id="patch-cord">Patch cord</h4>
<p>Autofluoresence contribution is not multiplied by laser noise.</p>
</section>
<section id="hemodynamics" class="level4">
<h4 class="anchored" data-anchor-id="hemodynamics">Hemodynamics</h4>
<p>Absorption due to oxygenated and deoxygenated hemoglobin attenuates the signal from the indicator. Further details are in a seciton below.</p>
<hr>
</section>
</section>
<section id="previous-approach-to-modeling-the-signal" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="previous-approach-to-modeling-the-signal"><span class="header-section-number">1.2</span> Previous approach to modeling the signal</h2>
<p><span id="eq-observation"><span class="math display">
\begin{align}
O(t,\lambda,j) &amp;= [ \left( \sum_{i \in \{\textrm{I},\textrm{AF}\}}{a(i,t) s(i,\lambda) w(i,j)} \right) H(t, \lambda) m(t) + b(\lambda,j) ] n(t,j) \\
H(t, \lambda) &amp;= e^{-(\mu_{\textrm{oxy}(\lambda)}h_{\textrm{oxy}}(t) + \mu_{\textrm{deoxy}(\lambda)}h_{\textrm{deoxy}}(t))}
\end{align}
\tag{1.8}</span></span></p>
<ul>
<li><span class="math inline">a(i,t)</span> for <span class="math inline">i \in \textrm{I}</span> has fast and slow components</li>
<li><span class="math inline">a(t) = c\{f(t)s_\textrm{bound}(\lambda) + (1-f(t))s_\textrm{free}(\lambda)\}</span> : an indicator with concentration <span class="math inline">c</span> exists in two states (e.g.&nbsp;bright, dark or bound, free) that have their own emission spectra.</li>
<li>Isosbestic point is the particular <span class="math inline">\lambda</span> where the two populations cannot be distinguished. This does not always exist for all indicators, but when it does exist it might be possible to use it for corrections related to Hemodynamics, see <span class="citation" data-cites="zhang2022spectral">Zhang et al. (<a href="references.html#ref-zhang2022spectral" role="doc-biblioref">2022</a>)</span></li>
<li><span class="math inline">h_{\textrm{oxy}}(t), h_{\textrm{deoxy}}(t)</span> : Blood concentration of hemoglobin in oxygenated or deoxygenated states over time</li>
<li><span class="math inline">a(i,t)</span> is multiplied by a decay term <span class="math inline">d(i,t)</span> associated with bleaching. <span class="math inline">d(i,t) = d_\textrm{fast}(i)e^{-\frac{t}{\tau_\textrm{fast}}} + d_\textrm{slow}(i)e^{-\frac{t}{\tau_\textrm{slow}}} + d_\textrm{constant}(i)</span></li>
</ul>
</section>
<section id="model-for-hemodynamics" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="model-for-hemodynamics"><span class="header-section-number">1.3</span> Model for hemodynamics</h2>
<p>Absorption by hemoglobin corrupts the signal. The Beer-Lambert law is used to model this effect in the generative model above.</p>
<ul>
<li><span class="math inline">\varepsilon</span>: extinction coefficient (in <span class="math inline">\textrm{cm}^{-1}\textrm{mole}^{-1}{L}</span>), see <span class="citation" data-cites="hemoglobinspectra">Prahl (<a href="references.html#ref-hemoglobinspectra" role="doc-biblioref">1998</a>)</span>. This is a function of <span class="math inline">\lambda</span></li>
<li><span class="math inline">h</span>: concentration (100 to 200 <span class="math inline">gL^{-1}</span> for Hemoglobin in brain, is a function of time, and linked to brain region-specific neuron activity</li>
<li><span class="math inline">l</span>: effective cuvette length in the Beer-Lambert law. We set this to 1 <span class="math inline">\textrm{cm}</span>, and assume no dependence on <span class="math inline">\lambda</span> here.</li>
<li><span class="math inline">M_{\textrm{Hg}}</span>: molar mass of Hemoglobin = 64,500 <span class="math inline">g\textrm{mole}^{-1}</span></li>
<li><span class="math inline">A</span>: absorbance, calculated as per Beer-Lambert’s law <span class="math inline">A = \frac{\varepsilon \times h \times {l}}{M_{\textrm{Hg}}}</span></li>
<li>Let <span class="math inline">f(t)</span> be fraction of hemoglobin in the oxygenated state. Define <span class="math inline">h_{\textrm{oxy}}</span>, <span class="math inline">h_{\textrm{deoxy}}</span>, <span class="math inline">\mu_\textrm{oxy}</span> and <span class="math inline">\mu_\textrm{deoxy}</span> as:</li>
</ul>
<p><span class="math display">
\begin{align*}
h_\textrm{oxy}(t) &amp;= f(t)h_{\textrm{total}}(t) \\
h_\textrm{deoxy}(t) &amp;= (1 - f(t))h_{\textrm{total}}(t) \\
\mu_\textrm{oxy}(\lambda) &amp;= \tfrac{\varepsilon_{\textrm{oxy}}(\lambda)}{M_{\textrm{Hg}}} \\
\mu_\textrm{deoxy}(\lambda) &amp;= \tfrac{\varepsilon_{\textrm{deoxy}}(\lambda)}{M_{\textrm{Hg}}}
\end{align*}
</span></p>
<ul>
<li>Replacing <span class="math inline">A</span> in the definition of absorbance: <span class="math inline">\frac{I}{I_o} = e^{-A}</span>: <span class="math display">
I(\lambda, t) = I_o(\lambda, t) e^{-(\mu_{\textrm{oxy}(\lambda)}h_{\textrm{oxy}}(t) + \mu_{\textrm{deoxy}(\lambda)}h_{\textrm{deoxy}}(t))}
</span></li>
</ul>
</section>
<section id="autofluorescence-1" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="autofluorescence-1"><span class="header-section-number">1.4</span> Autofluorescence</h2>
<p>Autofluorescence has a spectrum <span class="citation" data-cites="autofluorescencepectra">Hickl co. (<a href="references.html#ref-autofluorescencepectra" role="doc-biblioref">2022</a>)</span>, and it varies with time due to metabolic activity. NADH and FAD are molecules that fluoresce in the 400 nm - 700 nm range, see measurements in aqueous solutions in <span class="citation" data-cites="islam2013ph">Islam et al. (<a href="references.html#ref-islam2013ph" role="doc-biblioref">2013</a>)</span>.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-bridge2023fipha" class="csl-entry" role="listitem">
Bridge, Matthew F, Leslie R Wilson, Sambit Panda, Korey D Stevanovic, Ayland C Letsinger, Sandra McBride, and Jesse D Cushman. 2023. <span>“FiPhA: An Open-Source Platform for Fiber Photometry Analysis.”</span> <em>bioRxiv</em>.
</div>
<div id="ref-creamer2022correcting" class="csl-entry" role="listitem">
Creamer, Matthew S, Kevin S Chen, Andrew M Leifer, and Jonathan W Pillow. 2022. <span>“Correcting Motion Induced Fluorescence Artifacts in Two-Channel Neural Imaging.”</span> <em>PLoS Computational Biology</em> 18 (9): e1010421.
</div>
<div id="ref-grynkiewicz1985new" class="csl-entry" role="listitem">
Grynkiewicz, Grzegorz, Martin Poenie, and Roger Y Tsien. 1985. <span>“A New Generation of Ca2+ Indicators with Greatly Improved Fluorescence Properties.”</span> <em>Journal of Biological Chemistry</em> 260 (6): 3440–50.
</div>
<div id="ref-helmchen2011calibration" class="csl-entry" role="listitem">
Helmchen, Fritjof. 2011. <span>“Calibration Protocols for Fluorescent Calcium Indicators.”</span> <em>Cold Spring Harbor Protocols</em> 2011 (8): 980–84.
</div>
<div id="ref-autofluorescencepectra" class="csl-entry" role="listitem">
Hickl co., Becker &amp;. 2022. <span>“Autofluorescence Spectra.”</span> <span class="smallcaps">url:</span>&nbsp;<a href="https://www.becker-hickl.com/applications/metabolic-imaging/#application-principles" class="uri">https://www.becker-hickl.com/applications/metabolic-imaging/#application-principles</a>.
</div>
<div id="ref-islam2013ph" class="csl-entry" role="listitem">
Islam, Md Serajul, Masato Honma, Takakazu Nakabayashi, Masataka Kinjo, and Nobuhiro Ohta. 2013. <span>“pH Dependence of the Fluorescence Lifetime of FAD in Solution and in Cells.”</span> <em>International Journal of Molecular Sciences</em> 14 (1): 1952–63.
</div>
<div id="ref-hemoglobinspectra" class="csl-entry" role="listitem">
Prahl, Scott. 1998. <span>“Optical Spectra of Hemoglobin.”</span> <span class="smallcaps">url:</span>&nbsp;<a href="https://omlc.org/spectra/hemoglobin/summary.html" class="uri">https://omlc.org/spectra/hemoglobin/summary.html</a>.
</div>
<div id="ref-zhang2022spectral" class="csl-entry" role="listitem">
Zhang, Wei-Ting, Tzu-Hao Harry Chao, Yue Yang, Tzu-Wen Wang, Sung-Ho Lee, Esteban A Oyarzabal, Jingheng Zhou, et al. 2022. <span>“Spectral Fiber Photometry Derives Hemoglobin Concentration Changes for Accurate Measurement of Fluorescent Sensor Activity.”</span> <em>Cell Reports Methods</em> 2 (7): 100243.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Preface</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./01_methods.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Methods</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>