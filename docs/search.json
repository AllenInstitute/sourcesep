[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Source separation",
    "section": "",
    "text": "Preface\nThese are notes for the problem of source separation encountered in hyperspectral fiber photometry. The source for this page and related code is available to organization members on github."
  },
  {
    "objectID": "00_simulations.html#signal-from-indicators",
    "href": "00_simulations.html#signal-from-indicators",
    "title": "1  Simulating hyperspectral fiber photometry signals",
    "section": "1.1 Signal from indicators",
    "text": "1.1 Signal from indicators\n\nAssumptions / caveats\n\nWe may ignore spatial variation (e.g. related to illumination/ detection)\nWe may assume bound fraction is small (f \\ll 1)\nWe may assume that \\frac{\\Delta F}{F} \\ll (\\frac{\\Delta F}{F})_\\textrm{max}\n\n\n\nIndicator bleaching\nThe total number of indicator molecules that can fluoresce reduces over time and this is referred to as bleaching. Here we model bleaching as a sum of exponentials, one with a fast time constant and one with a slow time constant. C(t) = C_\\textrm{slow} e^{-\\frac{t}{\\tau_\\textrm{slow}}} + C_\\textrm{fast} e^{-\\frac{t}{\\tau_\\textrm{fast}}}\n\n\nIndicator signal\nThe fluorescing indicator molecules can exist in one of two states, bound to ligand or free. Let the fraction of the bound indicator be f_{\\textrm{b}}(t). Assuming emission spectra S_\\textrm{b}(\\lambda) and S_\\textrm{f}(\\lambda) for the different indicator states, power of the jth laser P(j,t), and efficiency of the laser to excite populations w_\\textrm{b}(j) and w_\\textrm{f}(j), the fluorescence readout F(t,\\lambda,j) is modeled as:\n\n\\begin{align*}\nF(t,\\lambda,j) = & \\textcolor{6488EA}{f_{\\textrm{b}}(t) S_\\textrm{b}(\\lambda)w_\\textrm{b}(j) C(t) P(j,t)} + \\\\\n                 & \\textcolor{AA2704}{(1 - f_{\\textrm{b}}(t)) S_\\textrm{f}(\\lambda)w_\\textrm{f}(j) C(t) P(j,t)}\n\\end{align*}\n\\tag{1.1}\nEquation 1.1 is analogous to the setup in and in Helmchen (2011). In the following we refer to f_{\\textrm{b}} as just f. Assuming a positive indicator (where the bound state is brighter than free state), define F_{\\max} and F_{\\min} as the signal when f=0 and f=1 respectively. We’ll pack terms other than f in Equation 1.1 into \\eta_\\textrm{b} and \\eta_\\textrm{f} for the bound and free components, and drop the arguments t, \\lambda, j for now. Then:\n\n\\begin{align*}\nF &= \\eta_{\\textrm{b}}f + \\eta_{\\textrm{f}}(1-f)\\\\\n  &= F_{\\min} + (\\eta_{\\textrm{b}} − \\eta_{\\textrm{f}})f \\\\\n  &= F_{\\max} − (\\eta_{\\textrm{b}} − \\eta_{\\textrm{f}})(1-f) \\\\\n\\implies \\frac{f}{1-f} &= \\frac{F - F_{\\min}}{F_{\\max} - F} \\\\\n\\end{align*}\n\\tag{1.2}\nDefining R := {F_{\\max}}/{F_{\\min}}, we can rewrite Equation 1.2 as: \n\\frac{f}{1-f} = \\frac{F / F_{\\max} − 1 / R}{1 − F / F_{\\max}}\n\\tag{1.3}\nEquation 1.3 only contains ratios of fluorosence; these terms are invariant to indicator concentration and laser power as in Equation 1.1.\n\n\nRelating ligand concentration to fluorescence\nThis section is based on discussions in Helmchen (2011) and Grynkiewicz, Poenie, and Tsien (1985) to relate observed signal to ligand (\\textrm{Ca}^{2+} in these studies) concentration in imaging experiments.\nFor indicator protein P and the ligand L, assumiing 1:1 complexation (i.e. 1 molecule of P binds to 1 molecule of L):\n\nL + P \\xrightleftharpoons[k_{d}]{k_{a}} LP\n\nAt equillibrium: \nk_d[LP] = k_a[L][P]\n\nThe dissociation constant K is defined as \\frac{k_d}{k_a}:\n\nK = \\frac{[L][P]}{[LP]} \\qquad [P] = \\frac{K[LP]}{[L]}\n\nThe fraction of bound indicator f: \nf = \\frac{[LP]}{[P] + [LP]}\n= \\frac{[L]}{K + [L]}\n\nThen [L] can be expressed as a function of f, and using Equation 1.2, we relate the ligand concentration to the observed fluoresence signal. \n[L] = K\\frac{f}{1-f} = K\\frac{F - F_{\\min}}{F_{\\max} - F} = K\\frac{F / F_{\\max} − 1 / R}{1 − F / F_{\\max}}\n\\tag{1.4}\nAs a further simplification, for f \\ll 1 (Taylor expansion of \\frac{f}{1-f} around f=0)\n\n[L] \\approx Kf\n\\tag{1.5}\n\n\nRelating ligand concentration to \\Delta F / F\nMeasuring F_{\\min} can be a problem, because of the presence of a baseline ligand concentration [L]_\\textrm{rest}, which is associated with a baseline fluorescence signal F_\\textrm{rest}. Using the equation derived in the section above:\n\n\\begin{align*}\n[L]_\\textrm{rest} &= K\\frac{F_\\textrm{rest} - F_{\\min}}{F_{\\max} - F_\\textrm{rest}}  \\\\\nF_{\\min} &= F_\\textrm{rest} - \\frac{[L]_\\textrm{rest}({F_{\\max} - F_\\textrm{rest}})}{K}   \\\\\n\\end{align*}\n\nReplace F_{\\min} in the expression for [L]:\n\n\\begin{align*}\n[L] &= K\\frac{F - F_{\\min}}{F_{\\max} - F} \\\\\n    &= K\\frac{F - (F_\\textrm{rest} - \\frac{[L]_\\textrm{rest}({F_{\\max} - F_\\textrm{rest}})}{K})}{F_{\\max} - F} \\\\\n    &= \\frac{K(F - F_\\textrm{rest}) + [L]_\\textrm{rest}({F_{\\max} - F_\\textrm{rest}})}{F_{\\max} - F} \\\\\n    &= \\frac{[L]_\\textrm{rest} + K\\frac{F - F_\\textrm{rest}}{F_{\\max} - F_\\textrm{rest}}}{ 1-\\frac{F - F_\\textrm{rest}}{F_{\\max} - F_\\textrm{rest}}} \\\\\n\\end{align*}\n\nDefine \\frac{\\Delta F}{F} := \\frac{F-F_\\textrm{rest}}{F_\\textrm{rest}} and (\\frac{\\Delta F}{F})_{\\max} := \\frac{F_{\\max}-F_\\textrm{rest}}{F_\\textrm{rest}}. Then we can rewrite [L] in terms of these quantities:\n\n\\begin{align*}\n[L] &= \\frac{[L]_\\textrm{rest} + K (\\frac{\\Delta F}{F}) / (\\frac{\\Delta F}{F})_{\\max}}{ 1-(\\frac{\\Delta F}{F}) / (\\frac{\\Delta F}{F})_{\\max}} \\\\\n\\end{align*}\n\\tag{1.6}\nThis equation is of the form f(x) = \\frac{a + bx}{1-x}. For small x, the Taylor series expansion around 0 is a+(a+b)x+\\mathcal{O}(x)^{2}.\nTherefore for small (\\frac{\\Delta F}{F}) / (\\frac{\\Delta F}{F})_{\\max}\n\n\\begin{align*}\n[L] & \\approx [L]_\\textrm{rest} + ([L]_\\textrm{rest} + ({K} / (\\frac{\\Delta F}{F})_{\\max})\\frac{\\Delta F}{F} \\\\\n\\Delta [L] & := [L] - [L]_\\textrm{rest} \\\\\n         & \\approx ([L]_\\textrm{rest} + {K} / (\\frac{\\Delta F}{F})_{\\max})\\frac{\\Delta F}{F} \\\\\n         & \\approx \\textrm{constant} \\times \\frac{\\Delta F}{F}\n\\end{align*}\n\\tag{1.7}\nThe constant has terms [L]_\\textrm{rest} (depends on cell/region being imaged), K (property of the indicator) and (\\frac{\\Delta F}{F})_{\\max} (depends on the indicator and optical setup).\n\n\nMultiple indicators\nFor experiments involving one indicator excited by a single laser and measured in a particular region of the emission spectrum, \\Delta f(t) \\propto {\\Delta F}/{F} according to Equation 1.5 and Equation 1.7.\nWith multiple indicators, the fluorescence signal would consist of multiple indicator-specific terms as shown for one indicator in Equation 1.1.\nDepending on the emission spectrum of the indicators, the signal at particular \\lambda would be expected to be dominated by a single indicator. We’ll treat this approach to analyzing the data as a baseline strategy."
  },
  {
    "objectID": "00_simulations.html#autofluorescence",
    "href": "00_simulations.html#autofluorescence",
    "title": "1  Simulating hyperspectral fiber photometry signals",
    "section": "1.2 Autofluorescence",
    "text": "1.2 Autofluorescence\nIn calculating \\Delta F / F, we assumed that the baseline fluorescence signal F_\\textrm{rest} is only due to a non-zero ligand concentration. Autofluorescence is an important source of noise to this end."
  },
  {
    "objectID": "00_simulations.html#isosbestic-control",
    "href": "00_simulations.html#isosbestic-control",
    "title": "1  Simulating hyperspectral fiber photometry signals",
    "section": "1.3 Isosbestic control",
    "text": "1.3 Isosbestic control\nIsosbestic control signal I refers to a signal that is independent of the ligand bound fraction f. The same noise sources that affect the indicator signal also affect the isosbestic control signal. Removing the component shared with I is common strategy to denoise fiber photometry data, Simpson et al. (2023).\nLet \\lambda^{\\textrm{exc}} refer to a particular excitation wavelength. From indicator characterization experiments, we have access to the following:\n\nExcitation spectrum for the bound state, w_\\textrm{b}(\\lambda^{\\textrm{exc}}).\nExcitation spectrum for the free state, w_\\textrm{f}(\\lambda^{\\textrm{exc}}), relative to the bound state spectrum.\nNormalized emission spectrum of the bound and free states S_\\textrm{b}(\\lambda) and S_\\textrm{f}(\\lambda), such that integral over \\lambda is 1.\n\nThe emission at two emission wavelengths \\lambda and \\lambda' while invoked by exciting the sample at \\lambda_{1}^{\\textrm{{exc}}} and \\lambda_{2}^{\\textrm{{exc}}} (each excitation wavelength corresponds to a different laser j):\nFollowing Equation 1.1,\n\n\\begin{align*}\nF_{1}(\\lambda)  &={f_{\\textrm{b}}S_{\\textrm{b}}(\\lambda)w_{\\textrm{b}}(\\lambda_{1}^{\\textrm{{exc}}})P(\\lambda_{1}^{\\textrm{{exc}}})}+{(1-f_{\\textrm{b}})S_{\\textrm{f}}(\\lambda)w_{\\textrm{f}}(\\lambda_{1}^{\\textrm{{exc}}})P(\\lambda_{1}^{\\textrm{{exc}}})} \\\\\nF_{2}(\\lambda') &={f_{\\textrm{b}}S_{\\textrm{b}}(\\lambda')w_{\\textrm{b}}(\\lambda_{2}^{\\textrm{{exc}}})P(\\lambda_{2}^{\\textrm{{exc}}})}+{(1-f_{\\textrm{b}})S_{\\textrm{f}}(\\lambda')w_{\\textrm{f}}(\\lambda_{2}^{\\textrm{{exc}}})P(\\lambda_{2}^{\\textrm{{exc}}})}\n\\end{align*}\n\nWe make a few notation changes to make things a bit more obvious:\n\n\\begin{align*}\na_{1}   &=S_{\\textrm{b}}(\\lambda)w_{\\textrm{b}}(\\lambda_{1}^{\\textrm{{exc}}})P(\\lambda_{1}^{\\textrm{{exc}}}) \\\\\nb_{1}   &=S_{\\textrm{f}}(\\lambda)w_{\\textrm{f}}(\\lambda_{1}^{\\textrm{{exc}}})P(\\lambda_{1}^{\\textrm{{exc}}}) \\\\\na_{2}   &=S_{\\textrm{b}}(\\lambda')w_{\\textrm{b}}(\\lambda_{2}^{\\textrm{{exc}}})P(\\lambda_{2}^{\\textrm{{exc}}}) \\\\\nb_{2}   &=S_{\\textrm{f}}(\\lambda')w_{\\textrm{f}}(\\lambda_{2}^{\\textrm{{exc}}})P(\\lambda_{2}^{\\textrm{{exc}}}) \\\\\nx(t)    &= f_\\textrm{b}(t) \\\\\ny(t)    &= 1-f_\\textrm{b}(t) \\\\\n\\end{align*}\n\nThen for observations at two different emission wavelengths \\lambda and \\lambda', we have:\n\n\\begin{align*}\nF_{1}(\\lambda)  &= {x(t)a_{1}}+{y(t)b_{1}} \\\\\nF_{2}(\\lambda') &= {x(t)a_{2}}+{y(t)b_{2}} \\\\\nx(t)+y(t)   &= 1 \\\\\n\\end{align*}\n\nConsider a linear combination of the observations:\n\nmF_{1}(\\lambda)+nF_{2}(\\lambda')    = x(t)(a_{1}m+a_{2}n)+y(t)(b_{1}m+b_{2}n)\n\\tag{1.8}\nThis would be independent of f(t) if and only if:\n\n\\begin{align*}\na_{1}m+a_{2}n   &= b_{1}m+b_{2}n \\\\\nm+n &\\neq 0 \\\\\n\\end{align*}\n\nThen the condition for such a linear combination to be considered as the isosbestic control signal is:\n\n\\frac{m}{n} = \\frac{b_2-a_2}{a_1-b_1} =\\frac{S_{\\textrm{f}}(\\lambda')w_{\\textrm{f}}(\\lambda_{2}^{\\textrm{{exc}}})P(\\lambda_{2}^{\\textrm{{exc}}})-S_{\\textrm{b}}(\\lambda')w_{\\textrm{b}}(\\lambda_{2}^{\\textrm{{exc}}})P(\\lambda_{2}^{\\textrm{{exc}}})}{S_{\\textrm{b}}(\\lambda)w_{\\textrm{b}}(\\lambda_{1}^{\\textrm{{exc}}})P(\\lambda_{1}^{\\textrm{{exc}}})-S_{\\textrm{f}}(\\lambda)w_{\\textrm{f}}(\\lambda_{1}^{\\textrm{{exc}}})P(\\lambda_{1}^{\\textrm{{exc}}})}\n\\tag{1.9}\n\n\n\n\n\n\nSpecial cases to obtain an isosbestic control signal\n\n\n\n\n\nExperimental setups may present various constraints. Here we consider two such special cases.\nCase I\nThere is one excitation laser, \\lambda^{\\textrm{{exc}}} and emission spectra of the bound and free states are the same, i.e. S_{\\textrm{f}}=S_{\\textrm{b}}=S. Then based on Equation 1.8 and Equation 1.9:\n\n\\frac{m}{n} =\\frac{S(\\lambda')w_{\\textrm{f}}(\\lambda^{\\textrm{{exc}}})P(\\lambda^{\\textrm{{exc}}})-S(\\lambda')w_{\\textrm{b}}(\\lambda^{\\textrm{{exc}}})P(\\lambda^{\\textrm{{exc}}})}{S(\\lambda)w_{\\textrm{b}}(\\lambda^{\\textrm{{exc}}})P(\\lambda^{\\textrm{{exc}}})-S(\\lambda)w_{\\textrm{f}}(\\lambda^{\\textrm{{exc}}})P(\\lambda^{\\textrm{{exc}}})} = -\\frac{S(\\lambda')}{S(\\lambda)}\n\nCase II\nThere is a single excitation laser, \\lambda^{\\textrm{{exc}}}, emission spectra of the bound and free states are the same, and there is only one observed emission wavelength. In this scenario, typicaly there is a dedicated laser to obtain the isosbestic control signal, for which the wavelength needs to be picked based on indicator properties.\nEquation 1.1 suggests that for F to be independent of f, we need w_\\textrm{b}(\\lambda^{\\textrm{{exc}}}) = w_\\textrm{f}(\\lambda^{\\textrm{{exc}}}), and for excitation by this laser, any emission wavelength \\lambda can serve as the isosbestic control.\n\n\n\nMotion-related artifacts are a common source of noise in fiber photometry experiments. Motion (e.g. head movements) disturbs the optical path (e.g. bending of the fiber), and typically attenuates the signal. This is a multiplicative effect which also affects the isosbestic control signal. Regressing out the component common to the isosbestic control signal and the indicator signal can reduce severity of this artifact, see Simpson et al. (2023) for an overview and Keevers, McNally, and Jean-Richard-dit-Bressel (2023) for an implementation of such a procedure.\nCreamer et al. (2022) discuss motion-related artifacts in a different system but may provide inspiration for solutions in mouse fiber photometry experiments."
  },
  {
    "objectID": "00_simulations.html#model-for-hemodynamics",
    "href": "00_simulations.html#model-for-hemodynamics",
    "title": "1  Simulating hyperspectral fiber photometry signals",
    "section": "1.4 Model for hemodynamics",
    "text": "1.4 Model for hemodynamics\nAbsorption by hemoglobin corrupts the signal. For in vivo measurements, the total cerebral blood volume, and fraction of oxygenated to deoxygenated hemoglobin are dynamic quantities. Oxygenrated and deoxygenated hemoglobin have different absorption spectra. The Beer-Lambert law can used to model this effect in the generative model above. A similar approach is considered in Zhang et al. (2022).\nPrevious work in Ma et al. (2016) may also be relevant to this problem.\n\n\\varepsilon: extinction coefficient (in {\\textrm{cm}}^{-1}{\\textrm{mole}}^{-1}{L}), see Prahl (1998). This is a function of \\lambda\nh: concentration (100 to 200 gL^{-1} for Hemoglobin in brain, is a function of time, and linked to brain region-specific neuron activity\nl: effective cuvette length in the Beer-Lambert law. We set this to 1 \\textrm{cm}, and assume no dependence on \\lambda here.\nM_{\\textrm{Hg}}: molar mass of Hemoglobin = 64,500 g\\textrm{mole}^{-1}\nA: absorbance, calculated as per Beer-Lambert’s law A = \\frac{\\varepsilon \\times h \\times {l}}{M_{\\textrm{Hg}}}\nLet f(t) be fraction of hemoglobin in the oxygenated state. Define h_{\\textrm{oxy}}, h_{\\textrm{deoxy}}, \\mu_{\\textrm{oxy}} and \\mu_{\\textrm{deoxy}} as:\n\n\n\\begin{align*}\nh_\\textrm{oxy}(t) &= f(t)h_{\\textrm{total}}(t) \\\\\nh_\\textrm{deoxy}(t) &= (1 - f(t))h_{\\textrm{total}}(t) \\\\\n\\mu_\\textrm{oxy}(\\lambda) &= \\tfrac{\\varepsilon_{\\textrm{oxy}}(\\lambda)}{M_{\\textrm{Hg}}} \\\\\n\\mu_\\textrm{deoxy}(\\lambda) &= \\tfrac{\\varepsilon_{\\textrm{deoxy}}(\\lambda)}{M_{\\textrm{Hg}}}\n\\end{align*}\n\n\nReplacing A in the definition of absorbance: \\frac{I}{I_o} = e^{-A}: \nI(\\lambda, t) = I_o(\\lambda, t) e^{-(\\mu_{\\textrm{oxy}(\\lambda)}h_{\\textrm{oxy}}(t) + \\mu_{\\textrm{deoxy}(\\lambda)}h_{\\textrm{deoxy}}(t))}\n\n\n\n\n\n\n\n\nApproach in Zhang et al. (2022)\n\n\n\n\n\nAs in Equation 1.1, fluorescence is linearly related to indicator concentration. A ratio of fluorescence measurements at any time t relative to reference time t_0 in the absence of any absorption:\n\n\\frac{F(t)}{F(t_0)} = \\frac{C(t)}{C(t_0)}\n\nAbsorption is considered along the path followed by the excitation light, and the path followed by the emission light. In Equation 1.1, this amounts to multiplying the incident power by a factor related to the first path, and the overall emission by another factor.\n\n\\begin{align*}\n\\frac{F(t,\\lambda)}{F(t_{0},\\lambda)}&=e^{-\\Delta\\mu(\\lambda)\\chi(\\lambda)}e^{-\\Delta\\mu(\\lambda_{{\\textrm{exc}}})\\chi(\\lambda_{{\\textrm{exc}}})}\\frac{C(t)}{C(t_{0})} \\\\\n\\log\\frac{F(t,\\lambda)}{F(t_{0},\\lambda)}&=-\\Delta\\mu(\\lambda)\\chi(\\lambda)-\\Delta\\mu(\\lambda_{{\\textrm{exc}}})\\chi(\\lambda_{{\\textrm{exc}}})+\\log(\\frac{C(t)}{C(t_{0})})\n\\end{align*}\n\nThe first two terms on the right hand side can be written in terms of contributions from HbO and HbR: \n\\begin{align*}\n\\Delta\\mu(\\lambda)\\chi(\\lambda)+\\Delta\\mu(\\lambda_{{\\textrm{exc}}})\\chi(\\lambda_{{\\textrm{exc}}})=& \\Delta C_{{\\textrm{HbO}}}(t)[\\epsilon_{{\\textrm{HbO}}}(\\lambda)+\\epsilon_{{\\textrm{HbO}}}(\\lambda_{{\\textrm{exc}}})] \\\\\n&+\\Delta C_{{\\textrm{HbR}}}(t)[\\epsilon_{{\\textrm{HbR}}}(\\lambda)+\\epsilon_{{\\textrm{HbR}}}(\\lambda_{{\\textrm{exc}}})]\n\\end{align*}\n\nConsider that emission is measured at n different wavelengths, indexed by i. Define the following terms:\n\n\\begin{align*}\nM_i(t) &= \\log\\left(\\frac{F(t, \\lambda_{i})}{F(0, \\lambda_{i})}\\right) \\\\\nA_i    &= \\epsilon_{\\textrm{HbO}}(\\lambda_{\\textrm{exc}})\\chi(\\lambda_{{\\textrm{exc}}}) +\n          \\epsilon_{\\textrm{HbO}}(\\lambda_{i})\\chi(\\lambda_{i}) \\\\\nB_i    &= \\epsilon_{\\textrm{HbR}}(\\lambda_{\\textrm{exc}})\\chi(\\lambda_{{\\textrm{exc}}}) +\n          \\epsilon_{\\textrm{HbR}}(\\lambda_{i})\\chi(\\lambda_{i})\n\\end{align*}\n\nIf the indicator is known to be activity-independent (i.e. a dead-sensor experiment), then authors propose that change in fluorescence can be attributed primarily to hemodynamics, and therefore \\log \\frac{C(t)}{C(0)} \\approx 0.\nAuthors propose solving the following optimization problem at each time step (with generalized method of moments) to estimate \\Delta C_{{\\textrm{HbO}}}(t) and \\Delta C_{{\\textrm{HbR}}}(t), with \\sigma(t) included as an additional parameter. \n\\underset{\\Delta C_{{\\textrm{HbO}}}(t),\\Delta C_{{\\textrm{HbR}}}(t),\\sigma(t)}{\\textrm{argmin}} \\sum_{i=1}^{n} [M(t)_i + \\Delta C_{{\\textrm{HbO}}}(t) A_i + \\Delta C_{{\\textrm{HbR}}}(t) B_i - \\sigma(t)) ]^2\n\nIn any in vivo experiment, this will be confounded by time-dependent autofluoresence. In our setup, we have multiple values for \\lambda_{\\textrm{exc}} as well. There is flexibility in choosing t_0 as well.\n\n\n\n\nBlooming and notch filters\nLarge power incident at any particular camera pixel can saturate that pixel, and also cause a spill-over effect at neighboring pixels referred to as blooming.\nFor measurements where the camera pixels correspond to different emission wavelengths, the problem is particularly severe around the value of the excitation laser wavelength.\nNotch filters can be used to attenuate the signal at particular wavelengths on it’s way back from the brain to the camera."
  },
  {
    "objectID": "00_simulations.html#previous-approach-to-modeling-the-signal",
    "href": "00_simulations.html#previous-approach-to-modeling-the-signal",
    "title": "1  Simulating hyperspectral fiber photometry signals",
    "section": "1.5 Previous approach to modeling the signal",
    "text": "1.5 Previous approach to modeling the signal\n\n\\begin{align}\nO(t,\\lambda,j) &= [ \\left( \\sum_{i \\in \\{\\textrm{I},\\textrm{AF}\\}}{a(i,t) s(i,\\lambda) w(i,j)} \\right) H(t, \\lambda) m(t) + b(\\lambda,j) ] n(t,j) \\\\\nH(t, \\lambda) &= e^{-(\\mu_{\\textrm{oxy}(\\lambda)}h_{\\textrm{oxy}}(t) + \\mu_{\\textrm{deoxy}(\\lambda)}h_{\\textrm{deoxy}}(t))}\n\\end{align}\n\\tag{1.10}\n\na(i,t) for i \\in \\textrm{I} has fast and slow components\na(t) = c\\{f(t)s_\\textrm{bound}(\\lambda) + (1-f(t))s_\\textrm{free}(\\lambda)\\} : an indicator with concentration c exists in two states (e.g. bright, dark or bound, free) that have their own emission spectra.\nIsosbestic point is the particular \\lambda where the two populations cannot be distinguished. This does not always exist for all indicators, but when it does exist it might be possible to use it for corrections related to Hemodynamics, see Zhang et al. (2022)\nh_{\\textrm{oxy}}(t), h_{\\textrm{deoxy}}(t) : Blood concentration of hemoglobin in oxygenated or deoxygenated states over time\na(i,t) is multiplied by a decay term d(i,t) associated with bleaching. d(i,t) = d_\\textrm{fast}(i)e^{-\\frac{t}{\\tau_\\textrm{fast}}} + d_\\textrm{slow}(i)e^{-\\frac{t}{\\tau_\\textrm{slow}}} + d_\\textrm{constant}(i)"
  },
  {
    "objectID": "00_simulations.html#autofluorescence-1",
    "href": "00_simulations.html#autofluorescence-1",
    "title": "1  Simulating hyperspectral fiber photometry signals",
    "section": "1.6 Autofluorescence",
    "text": "1.6 Autofluorescence\nAutofluorescence has a spectrum Hickl co. (2022), and it varies with time due to metabolic activity. NADH and FAD are molecules that fluoresce in the 400 nm - 700 nm range, see measurements in aqueous solutions in Islam et al. (2013)."
  },
  {
    "objectID": "00_simulations.html#experiment-proposals",
    "href": "00_simulations.html#experiment-proposals",
    "title": "1  Simulating hyperspectral fiber photometry signals",
    "section": "1.7 Experiment proposals",
    "text": "1.7 Experiment proposals\n\nControl experiment with dead sensor (i.e. activity independent measurement of fluorescence from the sensor)\nControl experiment with sensor with some form of triggered activity (stimulation/reward etc)\nHemodynamics measurement Zhang et al. (2022).\n\nEYFP expressed in primary somatosensory cortex (using AAV) of the forelimb region.\nIntravenously administered Rhodamine B for cerebral blood volume measurements.\nElectrical stimulation of the contralateral forepaw\n\n\n\n\n\n\nCreamer, Matthew S, Kevin S Chen, Andrew M Leifer, and Jonathan W Pillow. 2022. “Correcting Motion Induced Fluorescence Artifacts in Two-Channel Neural Imaging.” PLoS Computational Biology 18 (9): e1010421.\n\n\nGrynkiewicz, Grzegorz, Martin Poenie, and Roger Y Tsien. 1985. “A New Generation of Ca2+ Indicators with Greatly Improved Fluorescence Properties.” Journal of Biological Chemistry 260 (6): 3440–50.\n\n\nHelmchen, Fritjof. 2011. “Calibration Protocols for Fluorescent Calcium Indicators.” Cold Spring Harbor Protocols 2011 (8): 980–84.\n\n\nHickl co., Becker &. 2022. “Autofluorescence Spectra.” url: https://www.becker-hickl.com/applications/metabolic-imaging/#application-principles.\n\n\nIslam, Md Serajul, Masato Honma, Takakazu Nakabayashi, Masataka Kinjo, and Nobuhiro Ohta. 2013. “pH Dependence of the Fluorescence Lifetime of FAD in Solution and in Cells.” International Journal of Molecular Sciences 14 (1): 1952–63.\n\n\nKeevers, Luke J, Gavan P McNally, and Philip Jean-Richard-dit-Bressel. 2023. “Obtaining Artifact-Corrected Signals in Fiber Photometry: Isosbestic Signals, Robust Regression and dF/f Calculations.”\n\n\nMa, Ying, Mohammed A Shaik, Sharon H Kim, Mariel G Kozberg, David N Thibodeaux, Hanzhi T Zhao, Hang Yu, and Elizabeth MC Hillman. 2016. “Wide-Field Optical Mapping of Neural Activity and Brain Haemodynamics: Considerations and Novel Approaches.” Philosophical Transactions of the Royal Society B: Biological Sciences 371 (1705): 20150360.\n\n\nPrahl, Scott. 1998. “Optical Spectra of Hemoglobin.” url: https://omlc.org/spectra/hemoglobin/summary.html.\n\n\nSimpson, Eleanor H, Thomas Akam, Tommaso Patriarchi, Marta Blanco-Pozo, Lauren M Burgeno, Ali Mohebi, Stephanie J Cragg, and Mark E Walton. 2023. “Lights, Fiber, Action! A Primer on in Vivo Fiber Photometry.” Neuron.\n\n\nZhang, Wei-Ting, Tzu-Hao Harry Chao, Yue Yang, Tzu-Wen Wang, Sung-Ho Lee, Esteban A Oyarzabal, Jingheng Zhou, et al. 2022. “Spectral Fiber Photometry Derives Hemoglobin Concentration Changes for Accurate Measurement of Fluorescent Sensor Activity.” Cell Reports Methods 2 (7): 100243."
  },
  {
    "objectID": "01_methods.html#baselines",
    "href": "01_methods.html#baselines",
    "title": "2  Methods",
    "section": "2.1 Baselines",
    "text": "2.1 Baselines\n\nNon-negative matrix factorization (NMF)\n\nLet \\rpos denote non-negative real number set\nData X \\in \\rpos^{p \\times q}\nLet W \\in \\rpos^{p \\times r} and H \\in \\rpos^{r \\times q}.\n\nThe exact NMF problem X = WH is NP-hard. The approximate problem X \\approx WH is non-convex.\n\n\nVanilla gradient descent steps\n\\begin{aligned}\n\\frac{\\partial{}}{\\partial{W}} \\bigg[\\frac{1}{2} \\| Y - AH \\|_F^2 \\bigg]\n    &= \\frac{1}{2}\\frac{\\partial{}}{\\partial{W}}\\bigg[\\tr(Y^TY - Y^TAX - X^TA^TY + X^TA^TAX)   \\bigg] \\\\\n    &= \\frac{1}{2}\\frac{\\partial{}}{\\partial{W}}\\bigg[- \\tr(Y^TAX) - \\tr(X^TA^TY) + \\tr(X^TA^TAX)   \\bigg] \\\\\n    \n\\end{aligned}\n\n\nImplementation in scikit-learn\nscikit-learn provides implementations of the multiplicative update Lee and Seung (1999) and co-ordinate descent rules to solve the problem, includes regularizers for sparsity and smoothness. The problem considered in scikit-learn is:\n\n\\begin{aligned}\nL(W, H) &= \\frac{1}{2} \\bigg[ \\| X - WH \\|_F^2 \\\\\n            &+ p \\alpha_W \\bigg(2f  \\|\\vec(W)\\|_1 + (1 - f) \\| W \\|_{F}^2\\bigg) \\\\\n            &+ q \\alpha_H \\bigg(2f  \\|\\vec(H)\\|_1 + (1 - f) \\| H \\|_{F}^2\\bigg) \\bigg]\n\\end{aligned}\n\n\nX \\in \\mathbb{R_+}^{p \\times q}\n\\vec(A) flattens matrix A into a vector\n\\alpha_W, \\alpha_H , f are input parameters that control regularization\n\n\n\nThis sections on projected gradient descent, explanation for multiplicative update, and coordinate descent are reproduced with nominal changes from lecture notes by David Bindel.\n\n\nProjected gradient descent:\nTo minimize a function \\phi(x), we can use gradient descent. We introduce a projection function \\mathcal{P}(x) that maps x to the nearest feasible point. For the non-negativity constraint of NMF, \\mathcal{P}(x) = [x]_+ is the elementwise maximum of x and zero. The projected gradient descent iteration is then \n  x^{k+1} = \\mathcal{P}\\left( x^{k+1} - \\alpha_k \\nabla \\phi(x^k) \\right).\n\nThe convergence properties of projected gradient descent are similar to those of the unprojected version.\nIn order to write the gradient for the NMF objective without descending into a morass of indices, it is helpful to introduce the Frobenius inner product: for matrices X, Y \\in \\mathbb{R}^{m \\times n}, \n  \\langle X, Y \\rangle_F =\n  \\sum_{i,j} y_{ij} x_{ij} =\n  \\tr(Y^T X).\n The Frobenius inner product is the inner product associated with the Frobenius norm: \\|X\\|_F^2 = \\langle X, X \\rangle_F, and we can apply the usual product rule for differentiation to compute directional derivatives of \\phi(W,H) = \\|A-WH\\|_F^2/2 with respect to W and H: \\begin{align*}\n  \\delta \\phi\n  &= \\delta \\left[ \\frac{1}{2} \\langle A-WH, A-WH \\rangle_F \\right] \\\\\n  &= \\langle \\delta(A-WH), A-WH \\rangle_F \\\\\n  &= -\\langle (\\delta W) H, A-WH \\rangle_F\n     -\\langle W (\\delta H), A-WH \\rangle_F.\n\\end{align*} We let R = A-WH, and use the fact that the trace of a product of matrices is invariant under cyclic permutations of the matrices: \\begin{align*}\n  \\langle (\\delta W) H, R \\rangle_F\n  & = \\tr(H^T (\\delta W)^T R)\n    = \\tr((\\delta W)^T RH^T)\n    = \\langle \\delta W, RH^T \\rangle_F \\\\\n  \\langle W (\\delta H), R \\rangle_F\n  &= \\tr((\\delta H)^T W^T R) = \\langle \\delta H, W^T R \\rangle_F.\n\\end{align*} Therefore, the projected gradient descent iteration for this problem is \\begin{align*}\n  W^{\\mathrm{new}} &=\n  \\left[\n    W + \\alpha RH^T\n  \\right]_+ \\\\\n  H^{\\mathrm{new}} &=\n  \\left[\n    H + \\alpha W^T R\n  \\right]_+,\n\\end{align*} where in the interest of legibility we have suppressed the iteration index on the right hand side.\n\n\nMultiplicative updates\nOne of the earliest and most popular NMF solvers is the multiplicative update scheme of Lee and Seung. This has the form of a scaled gradient descent iteration where we replace the uniform step size \\alpha_k with a different (non-negative) step size for each entry of W and H:\n\n\\begin{align*}\n  W^{\\mathrm{new}} &=\n  \\left[\n    W + S \\odot \\left( AH^T - W H H^T \\right)\n  \\right]_+ \\\\\n  H^{\\mathrm{new}} &=\n  \\left[\n    H + S' \\odot \\left( W^T A - W^T W H \\right)\n  \\right]_+,  \n\\end{align*}\n\nwhere \\odot denotes elementwise multiplication. We similarly let \\oslash to denote elementwise division to define the nonnegative scaling matrices\n\n\\begin{align*}\nS  = W \\oslash (WHH^T) \\\\\nS' = H \\oslash (W^TWH)\n\\end{align*}\n\nWith these choices, two of the terms in the summation cancel, so that \n\\begin{align*}\n  W^{\\mathrm{new}} &= S  \\odot (AH^T) = W \\oslash (WHH^T) \\odot (AH^T) \\\\\n  H^{\\mathrm{new}} &= S' \\odot (W^TA) = H \\oslash (W^TWH) \\odot (W^TA).\n\\end{align*}\n\nAt each step of the Lee and Seung scheme, we scale the (non-negative) elements of W and H by non-negative factors, yielding a non-negative result. There is no need for a non-negative projection because the step sizes are chosen increasingly conservatively as elements of W and H approach zero. But because the steps are very conservative, the Lee and Seung algorithm may require a large number of steps to converge.\n\n\nCoordinate descent\nThe block coordinate descent method (also known as block relaxation, or nonlinear Gauss-Seidel) for solving \\min~\\phi(x_1, x_2, \\ldots, x_p) for x_i \\in \\Omega_i\ninvolves repeatedly optimizing with respect to one coordinate at a time. In the basic method, we iterate through each i and compute \n  x_i^{k+1} =\n  \\textrm{argmin}_\\xi \\phi(x_1^{k+1}, \\ldots, x_{i-1}^{k+1}, \\xi, x_{i+1}^k, \\ldots, x_p^k)\n The individual subproblems are often simpler than the full problem. If each subproblem has a unique solution (e.g.~if each subproblem is strongly convex), the iteration converges to a stationary point.\n\n\nSimple coordinate descent\nPerhaps the simplest coordinate descent algorithm for NMF sweeps through all entries of W and H. Let R = A-WH; then for the (i,j) coordinate of W, we compute the update w_{ij} = w_{ij} + s where s minimizes the quadratic\n\n\\begin{align*}\n\\frac{1}{2} \\|A-(W+se_i e_j^T) H\\|_F^s = \\\\\n\\frac{1}{2} \\|R\\|_F^2 - s \\langle (e_i e_j^T) , RH^T \\rangle_F + \\frac{1}{2} s^2 \\|e_i e_j^T H\\|_F^2\n\\end{align*}\n\nsubject to the constraint that s \\geq -w_{ij}. The solution to this optimization is\n\n  s = \\max\\left( -w_{ij}, \\frac{(RH^T)_{ij}}{(HH^T)_{jj}} \\right)\n\nTherefore, the update for w_{ij} is \n  s = \\max\\left( -w_{ij}, \\frac{(RH^T)_{ij}}{(HH^T)_{jj}} \\right), \\quad\n  w_{ij} := w_{ij} + s, \\quad\n  R_{i,:} := R_{i,:} - s H_{j,:}\n A similar computation for the elements of H gives us the update formulas\n\n\\begin{align*}\n  s = \\max\\left( -h_{ij}, \\frac{(W^TR)_{ij}}{(W^TW)_{ii}} \\right), \\quad\n  h_{ij} := h_{ij} + s, \\quad\n  R_{:,j} := R_{:,j} - s W_{:,i}.\n\\end{align*}\n\nSuperficially, this looks much like projected gradient descent with scaled step lengths. However, where in gradient descent (or the multiplicative updates of Lee and Seung) the updates for all entries of W and H are independent, in this coordinate descent algorithm we only have independence of updates for a single column of W or a single row of H. This is a disadvantage for efficient implementation.\n\n\nLinear unmixing approaches\nReview PICASSO."
  },
  {
    "objectID": "01_methods.html#training-a-conv-net",
    "href": "01_methods.html#training-a-conv-net",
    "title": "2  Methods",
    "section": "2.2 Training a conv-net",
    "text": "2.2 Training a conv-net\n\nThe raw signal is simulated with the generative model in Equation 1.10\nA conv-net is trained to reconstruct sensor activity $a(i,t)\nAssume n(t,j) is given\n\n\nWhat we learnt:\n\nThis strategy was implemented for synthetic data, and it works.\nThe approach does not directly generalize to real data.\nThe range of parameters used to generate synthetic data are key.\nIdeally we’d set these parameters in a rational range, or learn them from data.\nProblems in learning parameters for synthetic data:\n\nExperimental setup is changing.\nPosition of notch filters must also be modeled (adds to complexity).\nSimilarity metric (to compare synthetic with real data) must be well-defined to learn parameters through optimization.\n\n\n\n\nSoftware tools\nSimpson et al. (2023) is a recent review of best practices in fiber photometry.\nA list of software tools and algorithms relevant for fiber photometry data analysis.\n\nSherathiya et al. (2021):\nBruno et al. (2021):\nBridge et al. (2023):\nKeevers, McNally, and Jean-Richard-dit-Bressel (2023): Compare of OLS vs. iteratively reweighted least-squares to use isosbestic signal for artifact removal.\nCreamer et al. (2022): Motion correction for two channel data, where one of the channels has activity independent signals.\n\n\n\n\n\nBridge, Matthew F, Leslie R Wilson, Sambit Panda, Korey D Stevanovic, Ayland C Letsinger, Sandra McBride, and Jesse D Cushman. 2023. “FiPhA: An Open-Source Platform for Fiber Photometry Analysis.” bioRxiv.\n\n\nBruno, Carissa A, Chris O’Brien, Svetlana Bryant, Jennifer I Mejaes, David J Estrin, Carina Pizzano, and David J Barker. 2021. “pMAT: An Open-Source Software Suite for the Analysis of Fiber Photometry Data.” Pharmacology Biochemistry and Behavior 201: 173093.\n\n\nCreamer, Matthew S, Kevin S Chen, Andrew M Leifer, and Jonathan W Pillow. 2022. “Correcting Motion Induced Fluorescence Artifacts in Two-Channel Neural Imaging.” PLoS Computational Biology 18 (9): e1010421.\n\n\nKeevers, Luke J, Gavan P McNally, and Philip Jean-Richard-dit-Bressel. 2023. “Obtaining Artifact-Corrected Signals in Fiber Photometry: Isosbestic Signals, Robust Regression and dF/f Calculations.”\n\n\nLee, Daniel D, and H Sebastian Seung. 1999. “Learning the Parts of Objects by Non-Negative Matrix Factorization.” Nature 401 (6755): 788–91.\n\n\nSherathiya, Venus N, Michael D Schaid, Jillian L Seiler, Gabriela C Lopez, and Talia N Lerner. 2021. “GuPPy, a Python Toolbox for the Analysis of Fiber Photometry Data.” Scientific Reports 11 (1): 24212.\n\n\nSimpson, Eleanor H, Thomas Akam, Tommaso Patriarchi, Marta Blanco-Pozo, Lauren M Burgeno, Ali Mohebi, Stephanie J Cragg, and Mark E Walton. 2023. “Lights, Fiber, Action! A Primer on in Vivo Fiber Photometry.” Neuron."
  },
  {
    "objectID": "references.html",
    "href": "references.html",
    "title": "References",
    "section": "",
    "text": "Bridge, Matthew F, Leslie R Wilson, Sambit Panda, Korey D Stevanovic,\nAyland C Letsinger, Sandra McBride, and Jesse D Cushman. 2023.\n“FiPhA: An Open-Source Platform for Fiber Photometry\nAnalysis.” bioRxiv.\n\n\nBruno, Carissa A, Chris O’Brien, Svetlana Bryant, Jennifer I Mejaes,\nDavid J Estrin, Carina Pizzano, and David J Barker. 2021. “pMAT:\nAn Open-Source Software Suite for the Analysis of Fiber Photometry\nData.” Pharmacology Biochemistry and Behavior 201:\n173093.\n\n\nCreamer, Matthew S, Kevin S Chen, Andrew M Leifer, and Jonathan W\nPillow. 2022. “Correcting Motion Induced Fluorescence Artifacts in\nTwo-Channel Neural Imaging.” PLoS Computational Biology\n18 (9): e1010421.\n\n\nGrynkiewicz, Grzegorz, Martin Poenie, and Roger Y Tsien. 1985. “A\nNew Generation of Ca2+ Indicators with Greatly Improved Fluorescence\nProperties.” Journal of Biological Chemistry 260 (6):\n3440–50.\n\n\nHelmchen, Fritjof. 2011. “Calibration Protocols for Fluorescent\nCalcium Indicators.” Cold Spring Harbor Protocols 2011\n(8): 980–84.\n\n\nHickl co., Becker &. 2022. “Autofluorescence Spectra.”\nurl: https://www.becker-hickl.com/applications/metabolic-imaging/#application-principles.\n\n\nIslam, Md Serajul, Masato Honma, Takakazu Nakabayashi, Masataka Kinjo,\nand Nobuhiro Ohta. 2013. “pH Dependence of the Fluorescence\nLifetime of FAD in Solution and in Cells.” International\nJournal of Molecular Sciences 14 (1): 1952–63.\n\n\nKeevers, Luke J, Gavan P McNally, and Philip Jean-Richard-dit-Bressel.\n2023. “Obtaining Artifact-Corrected Signals in Fiber Photometry:\nIsosbestic Signals, Robust Regression and dF/f Calculations.”\n\n\nLee, Daniel D, and H Sebastian Seung. 1999. “Learning the Parts of\nObjects by Non-Negative Matrix Factorization.” Nature\n401 (6755): 788–91.\n\n\nMa, Ying, Mohammed A Shaik, Sharon H Kim, Mariel G Kozberg, David N\nThibodeaux, Hanzhi T Zhao, Hang Yu, and Elizabeth MC Hillman. 2016.\n“Wide-Field Optical Mapping of Neural Activity and Brain\nHaemodynamics: Considerations and Novel Approaches.”\nPhilosophical Transactions of the Royal Society B: Biological\nSciences 371 (1705): 20150360.\n\n\nPrahl, Scott. 1998. “Optical Spectra of Hemoglobin.” url: https://omlc.org/spectra/hemoglobin/summary.html.\n\n\nSherathiya, Venus N, Michael D Schaid, Jillian L Seiler, Gabriela C\nLopez, and Talia N Lerner. 2021. “GuPPy, a Python Toolbox for the\nAnalysis of Fiber Photometry Data.” Scientific Reports\n11 (1): 24212.\n\n\nSimpson, Eleanor H, Thomas Akam, Tommaso Patriarchi, Marta Blanco-Pozo,\nLauren M Burgeno, Ali Mohebi, Stephanie J Cragg, and Mark E Walton.\n2023. “Lights, Fiber, Action! A Primer on in Vivo Fiber\nPhotometry.” Neuron.\n\n\nZhang, Wei-Ting, Tzu-Hao Harry Chao, Yue Yang, Tzu-Wen Wang, Sung-Ho\nLee, Esteban A Oyarzabal, Jingheng Zhou, et al. 2022. “Spectral\nFiber Photometry Derives Hemoglobin Concentration Changes for Accurate\nMeasurement of Fluorescent Sensor Activity.” Cell Reports\nMethods 2 (7): 100243."
  }
]