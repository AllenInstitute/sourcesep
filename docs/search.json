[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Source separation",
    "section": "",
    "text": "Preface\nThese are notes for the problem of source separation encountered in hyperspectral fiber photometry. The source for this page and related code is available to organization members on github."
  },
  {
    "objectID": "00_simulations.html#phenomenological-model-for-observed-signal",
    "href": "00_simulations.html#phenomenological-model-for-observed-signal",
    "title": "1  Simulating hyperspectral fiber photometry signals",
    "section": "1.1 Phenomenological model for observed signal",
    "text": "1.1 Phenomenological model for observed signal\n\\[\n\\def\\lexc{\\lambda^{\\dagger}_{j}}\n\\]\n\n\n\n\n\n\n\n\n\nType\nSymbol\nCode\nDescription\n\n\n\n\n\n\\(O(t,\\lambda,j)\\)\nO\nobserved signal from the \\(j\\)-th laser at time \\(t\\) at spectral wavelength \\(\\lambda\\)\n\n\nConst\n\\(s(i,\\lambda)\\)\nS\nemission spectrum of sensor associated with \\(i\\)-th neuromodulator\n\n\nConst\n\\(e(\\lambda,j)\\)\nE\ntime-invariant spectral signature of \\(j\\)-th excitation laser\n\n\nConst\n\\(\\mu_\\textrm{oxy}(\\lambda)\\)\nMu_ox\nSpectrum of oxygenated hemolobin\n\n\nConst\n\\(\\mu_\\textrm{deoxy}(\\lambda)\\)\nMu_dox\nSpectrum of deoxygenated hemolobin\n\n\nParam\n\\(w(i,j)\\)\nW\nemission efficiency of \\(i\\)-th neuromodulator excited by \\(j\\)-th laser\n\n\nParam\n\\(a(i,t)\\)\nA\nsensor signal from time varying amount for the \\(i\\)-th neuromodulator\n\n\nParam\n\\(n(t,j)\\)\nN\nnoise from \\(j\\)-th laser\n\n\nParam\n\\(b(\\lambda,j)\\)\nB\npatch cord + laser fluorescence spectrum \\(j\\)-th laser\n\n\nParam\n\\(m(t)\\)\nM\nmotion correction (potentially depends on \\(i\\))\n\n\nParam\n\\(h_\\textrm{oxy}(t)\\)\nH_ox\nHemodynamics (oxygenated component)\n\n\nParam\n\\(h_\\textrm{deoxy}(t)\\)\nH_dox\nHemodynamics (deoxygenated component)\n\n\n\n\\[\n\\begin{align}\nO(t,\\lambda,j) &= [ \\left( \\sum_{i \\in \\{\\textrm{I},\\textrm{AF}\\}}{a(i,t) s(i,\\lambda) w(i,j)} \\right) H(t, \\lambda) m(t) + b(\\lambda,j) ] n(t,j) \\\\\nH(t, \\lambda) &= e^{-(\\mu_{\\textrm{oxy}(\\lambda)}h_{\\textrm{oxy}}(t) + \\mu_{\\textrm{deoxy}(\\lambda)}h_{\\textrm{deoxy}}(t))}\n\\end{align}\n\\tag{1.1}\\]\n\n\\(a(i,t)\\) for \\(i \\in \\textrm{I}\\) has fast and slow components\n\\(a(t) = c\\{f(t)s_\\textrm{bound}(\\lambda) + (1-f(t))s_\\textrm{free}(\\lambda)\\}\\) : an indicator with concentration \\(c\\) exists in two states (e.g. bright, dark or bound, free) that have their own emission spectra.\nIsosbestic point is the particular \\(\\lambda\\) where the two populations cannot be distinguished. This does not always exist for all indicators, but when it does exist it might be possible to use it for corrections related to Hemodynamics, see Zhang et al. (2022)\n\\(h_{\\textrm{oxy}}(t), h_{\\textrm{deoxy}}(t)\\) : Blood concentration of hemoglobin in oxygenated or deoxygenated states over time\n\\(a(i,t)\\) is multiplied by a decay term \\(d(i,t)\\) associated with bleaching. \\(d(i,t) = d_\\textrm{fast}(i)e^{-\\frac{t}{\\tau_\\textrm{fast}}} + d_\\textrm{slow}(i)e^{-\\frac{t}{\\tau_\\textrm{slow}}} + d_\\textrm{constant}(i)\\)"
  },
  {
    "objectID": "00_simulations.html#model-for-hemodynamics",
    "href": "00_simulations.html#model-for-hemodynamics",
    "title": "1  Simulating hyperspectral fiber photometry signals",
    "section": "1.2 Model for hemodynamics",
    "text": "1.2 Model for hemodynamics\nAbsorption by hemoglobin corrupts the signal. The Beer-Lambert law is used to model this effect in the generative model above.\n\n\\(\\varepsilon\\): extinction coefficient (in \\(\\textrm{cm}^{-1}\\textrm{mole}^{-1}{L}\\)), see Prahl (1998). This is a function of \\(\\lambda\\)\n\\(h\\): concentration (100 to 200 \\(gL^{-1}\\) for Hemoglobin in brain, is a function of time, and linked to brain region-specific neuron activity\n\\(l\\): effective cuvette length in the Beer-Lambert law. We set this to 1 \\(\\textrm{cm}\\), and assume no dependence on \\(\\lambda\\) here.\n\\(M_{\\textrm{Hg}}\\): molar mass of Hemoglobin = 64,500 \\(g\\textrm{mole}^{-1}\\)\n\\(A\\): absorbance, calculated as per Beer-Lambert’s law \\(A = \\frac{\\varepsilon \\times h \\times {l}}{M_{\\textrm{Hg}}}\\)\nLet \\(f(t)\\) be fraction of hemoglobin in the oxygenated state. Define \\(h_{\\textrm{oxy}}\\), \\(h_{\\textrm{deoxy}}\\), \\(\\mu_\\textrm{oxy}\\) and \\(\\mu_\\textrm{deoxy}\\) as:\n\n\\[\n\\begin{align*}\nh_\\textrm{oxy}(t) &= f(t)h_{\\textrm{total}}(t) \\\\\nh_\\textrm{deoxy}(t) &= (1 - f(t))h_{\\textrm{total}}(t) \\\\\n\\mu_\\textrm{oxy}(\\lambda) &= \\tfrac{\\varepsilon_{\\textrm{oxy}}(\\lambda)}{M_{\\textrm{Hg}}} \\\\\n\\mu_\\textrm{deoxy}(\\lambda) &= \\tfrac{\\varepsilon_{\\textrm{deoxy}}(\\lambda)}{M_{\\textrm{Hg}}}\n\\end{align*}\n\\]\n\nReplacing \\(A\\) in the definition of absorbance: \\(\\frac{I}{I_o} = e^{-A}\\): \\[\nI(\\lambda, t) = I_o(\\lambda, t) e^{-(\\mu_{\\textrm{oxy}(\\lambda)}h_{\\textrm{oxy}}(t) + \\mu_{\\textrm{deoxy}(\\lambda)}h_{\\textrm{deoxy}}(t))}\n\\]"
  },
  {
    "objectID": "00_simulations.html#autofluorescence",
    "href": "00_simulations.html#autofluorescence",
    "title": "1  Simulating hyperspectral fiber photometry signals",
    "section": "1.3 Autofluorescence",
    "text": "1.3 Autofluorescence\nAutofluorescence has a spectrum Hickl co. (2022), and it varies with time due to metabolic activity. NADH and FAD are molecules that fluoresce in the 400 nm - 700 nm range, see measurements in aqueous solutions in Islam et al. (2013).\n\n\n\n\nHickl co., Becker &. 2022. “Autofluorescence Spectra.” url: https://www.becker-hickl.com/applications/metabolic-imaging/#application-principles.\n\n\nIslam, Md Serajul, Masato Honma, Takakazu Nakabayashi, Masataka Kinjo, and Nobuhiro Ohta. 2013. “pH Dependence of the Fluorescence Lifetime of FAD in Solution and in Cells.” International Journal of Molecular Sciences 14 (1): 1952–63.\n\n\nPrahl, Scott. 1998. “Optical Spectra of Hemoglobin.” url: https://omlc.org/spectra/hemoglobin/summary.html.\n\n\nZhang, Wei-Ting, Tzu-Hao Harry Chao, Yue Yang, Tzu-Wen Wang, Sung-Ho Lee, Esteban A Oyarzabal, Jingheng Zhou, et al. 2022. “Spectral Fiber Photometry Derives Hemoglobin Concentration Changes for Accurate Measurement of Fluorescent Sensor Activity.” Cell Reports Methods 2 (7): 100243."
  },
  {
    "objectID": "01_methods.html#baselines",
    "href": "01_methods.html#baselines",
    "title": "2  Methods",
    "section": "2.1 Baselines",
    "text": "2.1 Baselines\n\nNon-negative matrix factorization (NMF)\n\nLet \\(\\mathbb{R_+}\\) denote non-negative real number set\nData \\(X \\in \\mathbb{R_+}^{p \\times q}\\)\nLet \\(W \\in \\mathbb{R_+}^{p \\times r}\\) and \\(H \\in \\mathbb{R_+}^{r \\times q}\\).\n\nThe exact NMF problem \\(X = WH\\) is NP-hard. The approximate problem \\(X \\approx WH\\) is non-convex.\n\n\nImplementation in scikit-learn\nscikit-learn provides implementations of the multiplicative update Lee and Seung (1999) and co-ordinate descent rules to solve the problem, includes regularizers for sparsity and smoothness. The problem considered in scikit-learn is:\n\\[\n\\begin{aligned}\nL(W, H) &= \\frac{1}{2} \\bigg[ \\| X - WH \\|_F^2 \\\\\n            &+ p \\alpha_W \\bigg(2f  \\|vec(W)\\|_1 + (1 - f) \\| W \\|_{F}^2\\bigg) \\\\\n            &+ q \\alpha_H \\bigg(2f  \\|vec(H)\\|_1 + (1 - f) \\| H \\|_{F}^2\\bigg) \\bigg]\n\\end{aligned}\n\\]\n\n\\(X \\in \\mathbb{R_+}^{p \\times q}\\)\n\\(\\vec(A)\\) flattens matrix \\(A\\) into a vector\n\\(\\alpha_W, \\alpha_H , f\\) are input parameters that control regularization\n\n\n\nThis sections on projected gradient descent, explanation for multiplicative update, and coordinate descent are reproduced with nominal changes from lecture notes by David Bindel.\n\n\nProjected gradient descent:\nTo minimize a function \\(\\phi(x)\\), we can use gradient descent. We introduce a projection function \\(\\mathcal{P}(x)\\) that maps \\(x\\) to the nearest feasible point. For the non-negativity constraint of NMF, \\(\\mathcal{P}(x) = [x]_+\\) is the elementwise maximum of \\(x\\) and zero. The projected gradient descent iteration is then \\[\n  x^{k+1} = \\mathcal{P}\\left( x^{k+1} - \\alpha_k \\nabla \\phi(x^k) \\right).\n\\]\nThe convergence properties of projected gradient descent are similar to those of the unprojected version.\nIn order to write the gradient for the NMF objective without descending into a morass of indices, it is helpful to introduce the Frobenius inner product: for matrices \\(X, Y \\in \\mathbb{R}^{m \\times n}\\), \\[\n  \\langle X, Y \\rangle_F =\n  \\sum_{i,j} y_{ij} x_{ij} =\n  \\tr(Y^T X).\n\\] The Frobenius inner product is the inner product associated with the Frobenius norm: \\(\\|X\\|_F^2 = \\langle X, X \\rangle_F\\), and we can apply the usual product rule for differentiation to compute directional derivatives of \\(\\phi(W,H) = \\|A-WH\\|_F^2/2\\) with respect to \\(W\\) and \\(H\\): \\[\\begin{align*}\n  \\delta \\phi\n  &= \\delta \\left[ \\frac{1}{2} \\langle A-WH, A-WH \\rangle_F \\right] \\\\\n  &= \\langle \\delta(A-WH), A-WH \\rangle_F \\\\\n  &= -\\langle (\\delta W) H, A-WH \\rangle_F\n     -\\langle W (\\delta H), A-WH \\rangle_F.\n\\end{align*}\\] We let \\(R = A-WH\\), and use the fact that the trace of a product of matrices is invariant under cyclic permutations of the matrices: \\[\\begin{align*}\n  \\langle (\\delta W) H, R \\rangle_F\n  & = \\tr(H^T (\\delta W)^T R)\n    = \\tr((\\delta W)^T RH^T)\n    = \\langle \\delta W, RH^T \\rangle_F \\\\\n  \\langle W (\\delta H), R \\rangle_F\n  &= \\tr((\\delta H)^T W^T R) = \\langle \\delta H, W^T R \\rangle_F.\n\\end{align*}\\] Therefore, the projected gradient descent iteration for this problem is \\[\\begin{align*}\n  W^{\\mathrm{new}} &=\n  \\left[\n    W + \\alpha RH^T\n  \\right]_+ \\\\\n  H^{\\mathrm{new}} &=\n  \\left[\n    H + \\alpha W^T R\n  \\right]_+,\n\\end{align*}\\] where in the interest of legibility we have suppressed the iteration index on the right hand side.\n\n\nMultiplicative updates\nOne of the earliest and most popular NMF solvers is the multiplicative update scheme of Lee and Seung. This has the form of a scaled gradient descent iteration where we replace the uniform step size \\(\\alpha_k\\) with a different (non-negative) step size for each entry of \\(W\\) and \\(H\\):\n\\[\n\\begin{align*}\n  W^{\\mathrm{new}} &=\n  \\left[\n    W + S \\odot \\left( AH^T - W H H^T \\right)\n  \\right]_+ \\\\\n  H^{\\mathrm{new}} &=\n  \\left[\n    H + S' \\odot \\left( W^T A - W^T W H \\right)\n  \\right]_+,  \n\\end{align*}\n\\]\nwhere \\(\\odot\\) denotes elementwise multiplication. We similarly let \\(\\oslash\\) to denote elementwise division to define the nonnegative scaling matrices\n\\[\n\\begin{align*}\nS  = W \\oslash (WHH^T) \\\\\nS' = H \\oslash (W^TWH)\n\\end{align*}\n\\]\nWith these choices, two of the terms in the summation cancel, so that \\[\n\\begin{align*}\n  W^{\\mathrm{new}} &= S  \\odot (AH^T) = W \\oslash (WHH^T) \\odot (AH^T) \\\\\n  H^{\\mathrm{new}} &= S' \\odot (W^TA) = H \\oslash (W^TWH) \\odot (W^TA).\n\\end{align*}\n\\]\nAt each step of the Lee and Seung scheme, we scale the (non-negative) elements of \\(W\\) and \\(H\\) by non-negative factors, yielding a non-negative result. There is no need for a non-negative projection because the step sizes are chosen increasingly conservatively as elements of \\(W\\) and \\(H\\) approach zero. But because the steps are very conservative, the Lee and Seung algorithm may require a large number of steps to converge.\n\n\nCoordinate descent\nThe block coordinate descent method (also known as block relaxation, or nonlinear Gauss-Seidel) for solving \\(\\min~\\phi(x_1, x_2, \\ldots, x_p)\\) for \\(x_i \\in \\Omega_i\\)\ninvolves repeatedly optimizing with respect to one coordinate at a time. In the basic method, we iterate through each \\(i\\) and compute \\[\n  x_i^{k+1} =\n  \\textrm{argmin}_\\xi \\phi(x_1^{k+1}, \\ldots, x_{i-1}^{k+1}, \\xi, x_{i+1}^k, \\ldots, x_p^k)\n\\] The individual subproblems are often simpler than the full problem. If each subproblem has a unique solution (e.g.~if each subproblem is strongly convex), the iteration converges to a stationary point.\n\n\nSimple coordinate descent\nPerhaps the simplest coordinate descent algorithm for NMF sweeps through all entries of \\(W\\) and \\(H\\). Let \\(R = A-WH\\); then for the \\((i,j)\\) coordinate of \\(W\\), we compute the update \\(w_{ij} = w_{ij} + s\\) where \\(s\\) minimizes the quadratic\n\\[\n\\begin{align*}\n\\frac{1}{2} \\|A-(W+se_i e_j^T) H\\|_F^s = \\\\\n\\frac{1}{2} \\|R\\|_F^2 - s \\langle (e_i e_j^T) , RH^T \\rangle_F + \\frac{1}{2} s^2 \\|e_i e_j^T H\\|_F^2\n\\end{align*}\n\\]\nsubject to the constraint that \\(s \\geq -w_{ij}\\). The solution to this optimization is\n\\[\n  s = \\max\\left( -w_{ij}, \\frac{(RH^T)_{ij}}{(HH^T)_{jj}} \\right)\n\\]\nTherefore, the update for \\(w_{ij}\\) is \\[\n  s = \\max\\left( -w_{ij}, \\frac{(RH^T)_{ij}}{(HH^T)_{jj}} \\right), \\quad\n  w_{ij} := w_{ij} + s, \\quad\n  R_{i,:} := R_{i,:} - s H_{j,:}\n\\] A similar computation for the elements of \\(H\\) gives us the update formulas\n\\[\n\\begin{align*}\n  s = \\max\\left( -h_{ij}, \\frac{(W^TR)_{ij}}{(W^TW)_{ii}} \\right), \\quad\n  h_{ij} := h_{ij} + s, \\quad\n  R_{:,j} := R_{:,j} - s W_{:,i}.\n\\end{align*}\n\\]\nSuperficially, this looks much like projected gradient descent with scaled step lengths. However, where in gradient descent (or the multiplicative updates of Lee and Seung) the updates for all entries of \\(W\\) and \\(H\\) are independent, in this coordinate descent algorithm we only have independence of updates for a single column of \\(W\\) or a single row of \\(H\\). This is a disadvantage for efficient implementation."
  },
  {
    "objectID": "01_methods.html#training-a-conv-net",
    "href": "01_methods.html#training-a-conv-net",
    "title": "2  Methods",
    "section": "2.2 Training a conv-net",
    "text": "2.2 Training a conv-net\n\nThe raw signal is simulated with the generative model in Equation 1.1\nA conv-net is trained to reconstruct sensor activity $a(i,t)\nAssume \\(n(t,j)\\) is given\n\n\nWhat we learnt:\n\nThis strategy was implemented for synthetic data, and it works.\nThe approach does not directly generalize to real data.\nThe range of parameters used to generate synthetic data are key.\nIdeally we’d set these parameters in a rational range, or learn them from data.\nProblems in learning parameters for synthetic data:\n\nExperimental setup is changing.\nPosition of notch filters must also be modeled (adds to complexity).\nSimilarity metric (to compare synthetic with real data) must be well-defined to learn parameters through optimization.\n\n\n\n\n\n\nLee, Daniel D, and H Sebastian Seung. 1999. “Learning the Parts of Objects by Non-Negative Matrix Factorization.” Nature 401 (6755): 788–91."
  },
  {
    "objectID": "references.html",
    "href": "references.html",
    "title": "References",
    "section": "",
    "text": "Hickl co., Becker &. 2022. “Autofluorescence Spectra.”\nurl: https://www.becker-hickl.com/applications/metabolic-imaging/#application-principles.\n\n\nIslam, Md Serajul, Masato Honma, Takakazu Nakabayashi, Masataka Kinjo,\nand Nobuhiro Ohta. 2013. “pH Dependence of the Fluorescence\nLifetime of FAD in Solution and in Cells.” International\nJournal of Molecular Sciences 14 (1): 1952–63.\n\n\nLee, Daniel D, and H Sebastian Seung. 1999. “Learning the Parts of\nObjects by Non-Negative Matrix Factorization.” Nature\n401 (6755): 788–91.\n\n\nPrahl, Scott. 1998. “Optical Spectra of Hemoglobin.” url: https://omlc.org/spectra/hemoglobin/summary.html.\n\n\nZhang, Wei-Ting, Tzu-Hao Harry Chao, Yue Yang, Tzu-Wen Wang, Sung-Ho\nLee, Esteban A Oyarzabal, Jingheng Zhou, et al. 2022. “Spectral\nFiber Photometry Derives Hemoglobin Concentration Changes for Accurate\nMeasurement of Fluorescent Sensor Activity.” Cell Reports\nMethods 2 (7): 100243."
  }
]